<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Management Dashboard - Game Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --secondary: #764ba2;
            --success: #10b981;
            --danger: #f43f5e;
            --warning: #f59e0b;
            --info: #3b82f6;
            --dark: #1f2937;
            --light: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --radius-sm: 0.375rem;
            --radius: 0.5rem;
            --radius-md: 0.75rem;
            --radius-lg: 1rem;
            --radius-xl: 1.5rem;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: #ffffff;
            min-height: 100vh;
            color: var(--gray-800);
            overflow-x: hidden;
            font-size: 16.4px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* ===== DASHBOARD HEADER ===== */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            color: var(--gray-800);
            padding: 1.5rem;
            background: #ffffff;
            border-radius: var(--radius-xl);
            backdrop-filter: blur(10px);
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow);
        }

        .dashboard-header h1 {
            font-size: 2.052rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* ===== EDIT MODE TOGGLE ===== */
        .edit-mode-toggle {
            display: none !important;
        }

        /* ===== DASHBOARD CONTAINER ===== */
        .dashboard-container {
            position: relative;
            min-height: 500px;
        }

        .plans-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 1.5rem;
            background: #ffffff;
            border-radius: var(--radius-xl);
            min-height: 500px;
            box-shadow: var(--shadow);
        }

        /* Empty State Card */
        .plan-card.empty-state-card {
            text-align: center;
            background: var(--gray-100) !important;
            border: 2px dashed var(--gray-300) !important;
            box-shadow: none !important;
            cursor: default !important;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 200px !important;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }

        .plan-card.empty-state-card:hover {
            transform: none !important;
            border-color: var(--gray-300) !important;
            background: var(--gray-100) !important;
        }

        .plan-card.empty-state-card::before {
            display: none;
        }

        .plan-card.empty-state-card .plan-card-header,
        .plan-card.empty-state-card .plan-meta,
        .plan-card.empty-state-card .plan-progress {
            display: none;
        }

        /* ===== PLAN CARDS ===== */
        .plan-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            height: 160px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            width: 100%;
            min-height: 160px;
            max-height: 160px;
            margin-bottom: 0;
        }

        .plan-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-xl);
            border-color: var(--primary);
        }

        .plan-card::before,
        .plan-card .fa-circle,
        .plan-card .progress-circle {
            display: none !important;
        }

        .plan-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .plan-card-header-left {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            flex: 1;
        }

        .plan-card-photo {
            width: 100px;
            height: 100px;
            border-radius: var(--radius);
            overflow: hidden;
            flex-shrink: 0;
            border: 2px solid var(--gray-200);
        }

        .plan-card-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .plan-card-photo-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .plan-card-title {
            flex: 1;
        }

        .plan-card h3 {
            color: var(--dark);
            font-size: 1.2825rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .plan-card-number {
            font-size: 0.89775rem;
            color: var(--primary);
            font-weight: 600;
        }

        .plan-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .plan-card:hover .plan-actions {
            opacity: 1;
        }

        .icon-btn {
            background: var(--gray-100);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-600);
            transition: all 0.3s ease;
        }

        .icon-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        .icon-btn.edit-btn:hover {
            background: var(--success);
        }

        .icon-btn.close-btn:hover {
            background: var(--danger);
        }

        .icon-btn.menu-btn:hover {
            background: var(--info);
        }

        .plan-meta {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 0.89775rem;
            color: var(--gray-500);
        }

        .plan-meta span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .plan-progress {
            margin-top: auto;
            display: none;
        }

        .plan-progress.show {
            display: block;
        }

        .progress-bar {
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* ===== IMPROVED MODEL CARD STYLING ===== */
        .model-card {
            background: linear-gradient(135deg, #10b981, #34d399);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow);
            color: white;
        }

        .model-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
            border-color: white;
        }

        .model-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent 60%, rgba(255,255,255,0.1) 100%);
            z-index: 1;
        }

        .model-card-content {
            position: relative;
            z-index: 2;
        }

        .model-card-header {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .model-card-photo {
            width: 90px;
            height: 90px;
            border-radius: var(--radius);
            overflow: hidden;
            flex-shrink: 0;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .model-card-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .model-card-photo-placeholder {
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .model-card-title-section {
            flex: 1;
        }

        .model-card h4 {
            color: white;
            font-size: 1.3rem;
            font-weight: 600;
            margin: 0 0 0.5rem 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .model-card-description {
            color: rgba(255,255,255,0.9);
            font-size: 0.95rem;
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .model-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: rgba(255,255,255,0.85);
        }

        .model-card-stats {
            display: flex;
            gap: 1rem;
        }

        .model-card-stats span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .model-card-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .model-card:hover .model-card-actions {
            opacity: 1;
        }

        .model-card-action-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .model-card-action-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        /* Different colors for different model levels */
        .model-card.level-2 {
            background: linear-gradient(135deg, #10b981, #34d399);
        }

        .model-card.level-3 {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
        }

        .model-card.level-4 {
            background: linear-gradient(135deg, #8b5cf6, #a78bfa);
        }

        .model-card.level-5 {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
        }

        .model-card.level-6 {
            background: linear-gradient(135deg, #ef4444, #f87171);
        }

        /* Model progress indicator */
        .model-progress {
            margin-top: 1rem;
        }

        .model-progress-bar {
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            overflow: hidden;
        }

        .model-progress-fill {
            height: 100%;
            background: white;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .model-progress-text {
            font-size: 0.8rem;
            margin-top: 0.25rem;
            text-align: right;
            color: rgba(255,255,255,0.9);
        }

        /* ===== IMPROVED CHECKLIST CARD ===== */
        .improved-checklist {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--success);
            transition: all 0.3s ease;
        }

        .improved-checklist:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .improved-checklist.inside-model {
            margin-top: 1rem;
            width: 100%;
        }

        .checklist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gray-200);
        }

        .checklist-title {
            color: var(--dark);
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .checklist-title i {
            color: var(--success);
            font-size: 1.5rem;
        }

        .checklist-stats {
            background: var(--gray-100);
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-size: 0.9rem;
            color: var(--gray-700);
            font-weight: 500;
        }

        .checklist-tasks {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .checklist-task {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: var(--radius);
            transition: all 0.3s ease;
            border: 1px solid transparent;
            position: relative;
        }

        .checklist-task:hover {
            background: white;
            border-color: var(--gray-300);
            transform: translateX(5px);
            box-shadow: var(--shadow-sm);
        }

        .checklist-task.completed {
            background: #f0fdf4;
            border-color: var(--success);
        }

        .checklist-task.completed::before {
            content: '✓';
            position: absolute;
            left: -10px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--success);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .checklist-task input[type="checkbox"] {
            margin-top: 0.25rem;
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--success);
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .checklist-task input[type="checkbox"]:hover {
            transform: scale(1.1);
        }

        .checklist-task label {
            flex-grow: 1;
            cursor: pointer;
            font-size: 1rem;
            color: var(--gray-800);
            line-height: 1.5;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .checklist-task.completed label {
            color: var(--gray-500);
            text-decoration: line-through;
        }

        .task-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .checklist-task:hover .task-actions {
            opacity: 1;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .checklist-task:last-child {
            animation: slideIn 0.3s ease;
        }

        @keyframes checkmark {
            0% {
                transform: scale(0);
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
            }
        }

        .checklist-task.completed input[type="checkbox"]:checked {
            animation: checkmark 0.3s ease;
        }

        .improved-checklist:empty::after {
            content: 'No tasks yet. Add your first task!';
            display: block;
            text-align: center;
            padding: 2rem;
            color: var(--gray-500);
            font-style: italic;
        }

        /* ===== DESCRIPTION STYLING ===== */
        .description-item .description-content {
            white-space: pre-line;
            line-height: 1.7;
            padding: 1rem;
            background: white;
            border-radius: var(--radius);
            border: 1px solid var(--gray-200);
            font-size: 1.026rem;
            color: var(--gray-700);
            max-height: 400px;
            overflow-y: auto;
            box-shadow: var(--shadow-sm);
        }

        .description-item .description-content::-webkit-scrollbar {
            width: 6px;
        }

        .description-item .description-content::-webkit-scrollbar-thumb {
            background: var(--gray-300);
            border-radius: 3px;
        }

        .description-item .description-content p {
            margin-bottom: 1rem;
        }

        .description-item .description-content p:last-child {
            margin-bottom: 0;
        }

        .description-item .description-content strong {
            color: var(--dark);
            font-weight: 600;
        }

        .description-item .description-content em {
            color: var(--gray-600);
            font-style: italic;
        }

        .description-item .description-content ul,
        .description-item .description-content ol {
            padding-left: 1.5rem;
            margin: 0.5rem 0;
        }

        .description-item .description-content li {
            margin-bottom: 0.25rem;
        }

        /* ===== ADD PLAN BUTTON ===== */
        .add-plan-btn {
            position: fixed;
            right: 2rem;
            bottom: 2rem;
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, var(--success), #34d399);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2.052rem;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            z-index: 100;
            border: none;
        }

        .add-plan-btn:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: var(--shadow-xl);
        }

        /* ===== MODAL BLUR EFFECT ===== */
        .modal-blur {
            filter: blur(5px);
            opacity: 0.7;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        /* Add Content Panel - Always on top */
        .add-content-panel {
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            bottom: auto !important;
            right: auto !important;
            z-index: 9999 !important;
            animation: popIn 0.3s ease !important;
            box-shadow: 0 25px 50px rgba(0,0,0,0.2);
            border: 2px solid var(--primary);
            max-height: 80vh;
            overflow-y: auto;
            display: none;
            background: white;
            border-radius: var(--radius-xl);
            padding: 0;
            width: 328.32px;
        }

        @keyframes popIn {
            from {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        .add-content-panel h3 {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: white;
            padding: 1rem 1.5rem;
            margin: 0;
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.2825rem;
        }

        .add-content-panel .content-options {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .content-option {
            padding: 0.75rem 1rem;
            background: var(--gray-50);
            border: 2px solid transparent;
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1rem;
            color: var(--gray-700);
            transition: all 0.3s ease;
            text-align: left;
            width: 100%;
        }

        .content-option:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .content-option i {
            font-size: 1.2rem;
            width: 24px;
        }

        .modal-overlay,
        .upload-modal {
            z-index: 1000;
        }

        /* ===== MODAL STYLES ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: white;
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-2xl);
            overflow: hidden;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 1.5rem 2rem;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.539rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-controls {
            display: flex;
            gap: 0.75rem;
        }

        .modal-content {
            padding: 2rem;
            overflow-y: auto;
            flex-grow: 1;
            background: #ffffff;
        }

        /* ===== CONTENT ITEMS ===== */
        .content-item {
            background: var(--gray-50);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
            position: relative;
        }

        .content-item:hover {
            transform: translateX(5px);
            background: var(--gray-100);
        }

        .content-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .content-item-type {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        .content-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* ===== CONTENT TYPE SPECIFIC STYLES ===== */
        .model-item {
            border-left-color: #10b981;
            cursor: pointer;
        }

        .model-item:hover {
            background: #f0fdf4;
        }

        .model-item .model-click-hint {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--info);
            color: white;
            border-radius: var(--radius);
            font-size: 0.89775rem;
            margin-top: 0.5rem;
        }

        .link-item {
            border-left-color: var(--info);
            cursor: pointer;
        }

        .link-item:hover {
            background: #f0f9ff;
        }

        .link-preview {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
            background: white;
            border-radius: var(--radius);
            text-decoration: none;
            color: inherit;
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
        }

        .link-preview:hover {
            border-color: var(--info);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .link-icon {
            font-size: 1.539rem;
            color: var(--info);
            min-width: 40px;
            display: flex;
            justify-content: center;
        }

        .link-content {
            flex-grow: 1;
        }

        .link-content h4 {
            margin: 0 0 0.25rem 0;
            color: var(--dark);
            font-weight: 600;
        }

        .link-url {
            font-size: 0.89775rem;
            color: var(--info);
            word-break: break-all;
            margin-bottom: 0.5rem;
        }

        .link-description {
            font-size: 0.89775rem;
            color: var(--gray-600);
            margin-bottom: 0.25rem;
        }

        .link-type-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: var(--gray-100);
            color: var(--gray-700);
            border-radius: var(--radius-sm);
            font-size: 0.7695rem;
            font-weight: 500;
        }

        .photo-item .photo-gallery {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .photo-item img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: var(--radius);
            transition: transform 0.3s ease;
            display: block;
        }

        .photo-item img:hover {
            transform: scale(1.05);
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: var(--radius);
            transition: background 0.3s ease;
        }

        .checkbox-item:hover {
            background: var(--gray-100);
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--success);
        }

        .checkbox-item label {
            flex-grow: 1;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .checkbox-item label.completed {
            color: var(--gray-400);
            text-decoration: line-through;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
        }

        .priority-item {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #e0e7ff;
            color: var(--primary);
            border-radius: var(--radius-lg);
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.89775rem;
            font-weight: 500;
        }

        /* ===== UPLOAD MODAL ===== */
        .upload-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .upload-modal-content {
            background: white;
            border-radius: var(--radius-xl);
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: scaleIn 0.3s ease;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .upload-modal-header {
            padding: 1.5rem;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .upload-modal-header h3 {
            margin: 0;
            font-size: 1.2825rem;
        }

        .close-upload {
            background: none;
            border: none;
            color: white;
            font-size: 2.052rem;
            cursor: pointer;
            line-height: 1;
            transition: transform 0.3s ease;
        }

        .close-upload:hover {
            transform: rotate(90deg);
        }

        .upload-modal-body {
            padding: 2rem;
            overflow-y: auto;
            flex-grow: 1;
            background: #ffffff;
        }

        /* Upload Area */
        .upload-area {
            border: 3px dashed var(--primary);
            border-radius: var(--radius-lg);
            padding: 3rem 2rem;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
        }

        .upload-area.dragover {
            background: #e3e8ff;
            border-color: var(--success);
        }

        .upload-icon {
            font-size: 4.104rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .upload-area p {
            color: var(--gray-600);
            margin-bottom: 1.5rem;
            font-size: 1.1286rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 1.026rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #0da271;
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-danger:hover {
            background: #e11d48;
        }

        /* Upload Progress */
        .upload-progress {
            margin-bottom: 2rem;
        }

        .progress-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
        }

        .progress-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: var(--radius-sm);
        }

        .progress-info {
            flex-grow: 1;
        }

        .progress-info span {
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.89775rem;
            color: var(--gray-600);
        }

        /* Uploaded Images */
        .uploaded-images {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
            justify-content: center;
        }

        .uploaded-image {
            position: relative;
            border-radius: var(--radius);
            overflow: hidden;
            flex: 0 0 150px;
        }

        .uploaded-image img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }

        .remove-image {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(244, 63, 94, 0.9);
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            transition: transform 0.3s ease;
        }

        .remove-image:hover {
            transform: scale(1.1);
        }

        /* ===== FORM STYLES ===== */
        .content-form {
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 2px solid var(--gray-200);
            position: relative;
        }

        .edit-form {
            background: #fff3cd;
            border-color: #ffc107;
        }

        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .form-header h4 {
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 0;
        }

        .form-close-btn {
            background: none;
            border: none;
            color: var(--gray-500);
            cursor: pointer;
            font-size: 1.2825rem;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius);
            transition: all 0.3s ease;
        }

        .form-close-btn:hover {
            background: var(--gray-200);
            color: var(--danger);
            transform: rotate(90deg);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 1.026rem;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            justify-content: flex-end;
        }

        /* ===== NOTIFICATIONS ===== */
        #notificationArea {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 3000;
        }

        .notification {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-lg);
            margin-bottom: 0.5rem;
            box-shadow: var(--shadow-lg);
            animation: slideInRight 0.3s ease;
            max-width: 350px;
            font-size: 0.9rem;
            line-height: 1.4;
            opacity: 0.85;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 0.85;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 0.85;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .notification.success {
            background: var(--success);
            color: white;
        }

        .notification.error {
            background: var(--danger);
            color: white;
        }

        .notification.info {
            background: var(--info);
            color: white;
        }

        .notification.warning {
            background: var(--warning);
            color: white;
        }

        /* ===== HIERARCHY DISPLAY ===== */
        .hierarchy-container {
            padding: 1.5rem;
            background: white;
            border-radius: var(--radius-lg);
            margin-top: 2rem;
            border: 2px solid var(--gray-200);
        }

        .hierarchy-container h3 {
            margin-bottom: 1rem;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .hierarchy-node {
            margin-left: 2rem;
            padding: 0.75rem;
            border-left: 3px solid var(--gray-300);
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: var(--radius);
        }

        .hierarchy-node:hover {
            background: var(--gray-50);
            border-left-color: var(--primary);
            padding-left: 1rem;
        }

        .hierarchy-node::before {
            content: '↳';
            margin-right: 0.5rem;
            color: var(--primary);
            font-weight: bold;
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray-500);
        }

        .empty-icon {
            font-size: 4.104rem;
            margin-bottom: 1.5rem;
            color: var(--gray-300);
        }

        .empty-state h3 {
            margin-bottom: 0.75rem;
            color: var(--gray-600);
        }

        /* ===== DRAG & DROP ===== */
        .drag-handle {
            cursor: move;
            color: var(--gray-400);
            padding: 0.5rem;
            border-radius: var(--radius-sm);
        }

        .drag-handle:hover {
            background: var(--gray-200);
            color: var(--gray-600);
        }

        .content-item.dragging {
            opacity: 0.5;
            transform: rotate(3deg);
            border: 2px dashed var(--primary);
        }

        /* ===== LOADING STATES ===== */
        .loading {
            position: relative;
            opacity: 0.7;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            border: 3px solid var(--gray-300);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            html {
                font-size: 11.286px;
            }
            
            .container {
                padding: 0.8rem;
            }

            .dashboard-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
                padding: 1rem;
                margin-bottom: 1.2rem;
            }

            .dashboard-header h1 {
                font-size: 1.6416rem;
            }

            .plans-container {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }

            .plan-card {
                padding: 1.2rem;
                height: 150px;
                min-height: 150px;
                max-height: 150px;
            }
            
            .plan-card h3 {
                font-size: 1.026rem;
            }
            
            .plan-card-photo {
                width: 80px;
                height: 80px;
            }
            
            .plan-meta {
                font-size: 0.7695rem;
            }
            
            .plan-actions {
                opacity: 1;
            }

            .add-content-panel {
                width: calc(100% - 1.5rem);
                max-width: 266.76px;
            }
            
            .add-content-panel h3 {
                padding: 0.8rem 1rem;
                font-size: 1.026rem;
            }
            
            .content-options {
                padding: 1rem;
            }
            
            .content-option {
                padding: 0.6rem 0.8rem;
                font-size: 0.8721rem;
            }

            .modal {
                max-height: 85vh;
            }

            .modal-header {
                padding: 1rem 1.2rem;
            }
            
            .modal-header h2 {
                font-size: 1.2312rem;
            }

            .modal-content {
                padding: 1.2rem;
            }
            
            .content-item {
                padding: 1rem;
            }
            
            .content-item-header {
                margin-bottom: 0.8rem;
            }

            .model-card-photo {
                width: 70px;
                height: 70px;
            }

            .form-actions {
                flex-direction: column;
            }

            .form-actions .btn {
                width: 100%;
            }
            
            .form-input {
                padding: 0.6rem 0.8rem;
                font-size: 0.9234rem;
            }
            
            .btn {
                padding: 0.6rem 1rem;
                font-size: 0.9234rem;
            }
            
            .icon-btn {
                width: 32px;
                height: 32px;
            }

            .uploaded-images {
                grid-template-columns: repeat(auto-fill, minmax(96px, 1fr));
            }
            
            .uploaded-image img {
                height: 120px;
            }

            .photo-item .photo-gallery {
                grid-template-columns: repeat(auto-fill, minmax(96px, 1fr));
            }
            
            .photo-item img {
                height: 120px;
                width: 120px;
            }
            
            .upload-modal-body {
                padding: 1.2rem;
            }
            
            .upload-area {
                padding: 2rem 1rem;
            }
            
            .upload-icon {
                font-size: 3.078rem;
            }
            
            .upload-area p {
                font-size: 0.9747rem;
            }
            
            .progress-item img {
                width: 40px;
                height: 40px;
            }
            
            h1, h2, h3, h4, h5, h6 {
                font-size: 87.21% !important;
            }
            
            .progress-circle {
                width: 65.664px;
                height: 65.664px;
            }
            
            .progress-circle-text {
                font-size: 1.026rem;
            }
            
            .kanban-column {
                min-width: 200px;
                padding: 0.8rem;
            }
            
            .template-gallery {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
            
            .achievement-badge {
                padding: 0.8rem;
                min-width: 80px;
            }
            
            .achievement-badge i {
                font-size: 1.6416rem;
            }
            
            .form-group {
                margin-bottom: 0.8rem;
            }
            
            .content-form {
                padding: 1rem;
            }
            
            .timeline-item {
                padding: 0.8rem;
            }
            
            .link-preview {
                padding: 0.8rem;
            }
            
            .link-icon {
                font-size: 1.2312rem;
                min-width: 32px;
            }
            
            .notification {
                padding: 0.8rem 1rem;
                max-width: 280px;
                font-size: 0.9rem;
                opacity: 0.85;
            }
            
            .hierarchy-container {
                padding: 1rem;
            }
            
            .gamification-panel {
                padding: 1rem;
            }
            
            .xp-bar {
                height: 8px;
            }
            
            .empty-state {
                padding: 2rem 1rem;
            }
            
            .empty-icon {
                font-size: 3.078rem;
            }
            
            .stats-badge {
                padding: 0.4rem 0.8rem;
                font-size: 0.8721rem;
            }
            
            .stats-badge i {
                font-size: 1.026rem;
            }
            
            .edit-mode-toggle {
                padding: 0.6rem 1rem;
            }
            
            .switch {
                width: 48px;
                height: 24px;
            }
            
            .slider:before {
                height: 18px;
                width: 18px;
                left: 3px;
                bottom: 3px;
            }
            
            input:checked + .slider:before {
                transform: translateX(24px);
            }
            
            .add-plan-btn {
                width: 56px;
                height: 56px;
                font-size: 1.6416rem;
                right: 1rem;
                bottom: 1rem;
            }
            
            .remove-image {
                width: 20px;
                height: 20px;
                font-size: 0.6rem;
            }
            
            .priority-item {
                padding: 0.4rem 0.8rem;
                font-size: 0.7695rem;
            }
            
            .skill-dot {
                width: 8px;
                height: 8px;
            }
            
            .hierarchy-node {
                margin-left: 1.5rem;
                padding: 0.6rem;
            }
            
            .model-card-photo {
                width: 70px;
                height: 70px;
            }
            
            .improved-checklist {
                padding: 1rem;
            }
            
            .checklist-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .checklist-task {
                padding: 0.75rem;
            }
            
            .checklist-task label {
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .header-actions {
                flex-direction: column;
                gap: 0.75rem;
                width: 100%;
            }

            .edit-mode-toggle {
                width: 100%;
                justify-content: center;
            }

            .add-plan-btn {
                right: 0.8rem;
                bottom: 0.8rem;
                width: 52px;
                height: 52px;
                font-size: 1.539rem;
            }
            
            .add-content-panel {
                width: calc(100% - 1rem);
            }
            
            html {
                font-size: 10.26px;
            }
            
            .modal-content {
                padding: 1rem;
            }
            
            .modal-header {
                padding: 0.8rem 1rem;
            }
            
            .upload-modal-header {
                padding: 1rem;
            }
            
            .upload-modal-body {
                padding: 1rem;
            }
            
            .plan-card {
                height: 140px;
                min-height: 140px;
                max-height: 140px;
            }
            
            .plan-card-photo {
                width: 60px;
                height: 60px;
            }
            
            .model-card-photo {
                width: 60px;
                height: 60px;
            }
        }

        /* ===== CUSTOM SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray-400);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gray-500);
        }

        /* ===== ACHIEVEMENT BADGES ===== */
        .achievement-badge {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            border-radius: var(--radius-lg);
            margin: 0.5rem;
            text-align: center;
            min-width: 100px;
            box-shadow: var(--shadow);
        }

        .achievement-badge i {
            font-size: 2.052rem;
            margin-bottom: 0.5rem;
        }

        .achievement-badge .badge-name {
            font-size: 0.7695rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .achievement-badge .badge-desc {
            font-size: 0.64125rem;
            opacity: 0.9;
        }

        /* ===== PROGRESS TRACKER ===== */
        .progress-tracker {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow);
        }

        .progress-tracker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .progress-tracker h4 {
            color: var(--dark);
            font-size: 1.15425rem;
        }

        .progress-circle {
            position: relative;
            width: 82.08px;
            height: 82.08px;
        }

        .progress-circle-svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .progress-circle-bg {
            fill: none;
            stroke: var(--gray-200);
            stroke-width: 8;
        }

        .progress-circle-fill {
            fill: none;
            stroke: var(--success);
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 251;
            stroke-dashoffset: calc(251 - (251 * var(--progress)) / 100);
            transition: stroke-dashoffset 0.5s ease;
        }

        .progress-circle-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2825rem;
            font-weight: 600;
            color: var(--dark);
        }

        /* ===== KANBAN BOARD ===== */
        .kanban-board {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding: 1rem 0;
            margin-bottom: 1rem;
        }

        .kanban-column {
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            padding: 1rem;
            min-width: 250px;
            max-width: 300px;
        }

        .kanban-column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--gray-200);
        }

        .kanban-column-title {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.89775rem;
        }

        .kanban-task {
            background: white;
            border-radius: var(--radius);
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            box-shadow: var(--shadow-sm);
            cursor: move;
            border-left: 3px solid var(--primary);
        }

        .kanban-task:hover {
            box-shadow: var(--shadow);
        }

        /* ===== SWOT ANALYSIS ===== */
        .swot-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .swot-quadrant {
            padding: 1rem;
            border-radius: var(--radius);
            border: 2px solid;
        }

        .swot-strengths {
            border-color: var(--success);
            background: #f0fdf4;
        }

        .swot-weaknesses {
            border-color: var(--danger);
            background: #fef2f2;
        }

        .swot-opportunities {
            border-color: var(--info);
            background: #eff6ff;
        }

        .swot-threats {
            border-color: var(--warning);
            background: #fffbeb;
        }

        .swot-quadrant h5 {
            margin-bottom: 0.75rem;
            color: inherit;
            font-size: 0.89775rem;
            font-weight: 600;
        }

        .swot-item {
            background: white;
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            border-radius: var(--radius-sm);
            font-size: 0.89775rem;
        }
        
        /* ===== TIMELINE ITEM FIX ===== */
        .timeline-content {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--warning);
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }
        
        .timeline-content:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .timeline-details {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
        }
        
        .timeline-dates {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .timeline-dates span {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--gray-100);
            border-radius: var(--radius);
            font-size: 0.9rem;
        }
        
        .timeline-dates i {
            color: var(--warning);
        }
        
        .timeline-arrow {
            color: var(--gray-400);
        }
    </style>
</head>
<body>
    <!-- Main Container -->
    <div class="container">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <h1><i class="fas fa-gamepad"></i> Life Management Dashboard</h1>
            <div class="header-actions">
                <!-- Edit Mode Toggle REMOVED -->
            </div>
        </div>

        <!-- Dashboard Content -->
        <div class="dashboard-container">
            <div class="plans-container" id="plansContainer">
                <!-- Plans will be dynamically added here -->
                <div class="plan-card empty-state-card">
                    <div class="empty-state">
                        <i class="fas fa-inbox empty-icon"></i>
                        <h3>No Plans Yet</h3>
                        <p>Click the + button to create your first plan!</p>
                    </div>
                </div>
            </div>
            
            <!-- Add Plan Button -->
            <button class="add-plan-btn" id="addPlanBtn">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <!-- Notification Area -->
        <div id="notificationArea"></div>
    </div>

    <!-- Main Plan Modal Structure -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="modal">
            <div class="modal-header">
                <h2><i class="fas fa-folder"></i> <span id="modalTitle">New Project</span></h2>
                <div class="modal-controls">
                    <button class="icon-btn menu-btn" id="modalMenuBtn" title="Add Content">
                        <i class="fas fa-bars"></i>
                    </button>
                    <button class="icon-btn reorder-btn" id="reorderBtn" title="Reorder Items" style="display: none;">
                        <i class="fas fa-sort"></i>
                    </button>
                    <button class="icon-btn edit-btn" id="modalEditBtn" title="Edit Mode">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="icon-btn close-btn" id="modalCloseBtn" title="Close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="modal-content" id="modalContent">
                <!-- Content will be dynamically added -->
                <div class="empty-state">
                    <i class="fas fa-plus-circle empty-icon"></i>
                    <h3>No Content Yet</h3>
                    <p>Turn on Edit Mode and add content!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Generic Sub-Plan Modal Structure (reusable for unlimited levels) -->
    <div class="modal-overlay" id="subPlanModalOverlay" style="display: none; z-index: 2000;">
        <div class="modal" id="subPlanModal" style="max-width: 800px;">
            <div class="modal-header">
                <h2><i class="fas fa-folder-tree"></i> <span id="subPlanModalTitle">Sub-Project</span></h2>
                <div class="modal-controls">
                    <button class="icon-btn menu-btn" id="subPlanModalMenuBtn" title="Add Content">
                        <i class="fas fa-bars"></i>
                    </button>
                    <button class="icon-btn edit-btn" id="subPlanModalEditBtn" title="Edit Mode">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="icon-btn close-btn" id="subPlanModalCloseBtn" title="Close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="modal-content" id="subPlanModalContent">
                <!-- Sub-plan content will be dynamically added -->
                <div class="empty-state">
                    <i class="fas fa-plus-circle empty-icon"></i>
                    <h3>No Content Yet</h3>
                    <p>This sub-project is empty</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Content Panel -->
    <div class="add-content-panel" id="addContentPanel">
        <h3><i class="fas fa-plus-circle"></i> Add Content</h3>
        <div class="content-options">
            <button class="content-option" data-type="model">
                <i class="fas fa-cube"></i> New Model
            </button>
            <button class="content-option" data-type="photo">
                <i class="fas fa-images"></i> Photos / Images
            </button>
            <button class="content-option" data-type="description">
                <i class="fas fa-sticky-note"></i> Description
            </button>
            <button class="content-option" data-type="checkbox">
                <i class="fas fa-tasks"></i> Checklist
            </button>
            <button class="content-option" data-type="timeline">
                <i class="fas fa-calendar-alt"></i> Timeline
            </button>
            <button class="content-option" data-type="priority">
                <i class="fas fa-flag"></i> Priority & Tags
            </button>
            <button class="content-option" data-type="link">
                <i class="fas fa-link"></i> Links
            </button>
            <button class="content-option" data-type="progress">
                <i class="fas fa-chart-line"></i> Progress Tracker
            </button>
            <button class="content-option" data-type="kanban">
                <i class="fas fa-columns"></i> Kanban Board
            </button>
            <button class="content-option" data-type="swot">
                <i class="fas fa-th-large"></i> SWOT Analysis
            </button>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="upload-modal" id="uploadModal">
        <div class="upload-modal-content">
            <div class="upload-modal-header">
                <h3><i class="fas fa-cloud-upload-alt"></i> Upload Images & Files</h3>
                <button class="close-upload" id="closeUpload">&times;</button>
            </div>
            <div class="upload-modal-body">
                <div class="upload-area" id="dropArea">
                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                    <p>Drag & drop files here or click to browse</p>
                    <input type="file" id="fileInput" accept="image/*,.pdf,.doc,.docx,.txt" multiple style="display: none;">
                    <button class="btn" id="browseBtn">
                        <i class="fas fa-folder-open"></i> Browse Files
                    </button>
                    <p style="margin-top: 1rem; font-size: 0.89775rem; color: var(--gray-500);">
                        Supports: JPG, PNG, GIF, WebP, SVG, PDF, DOC, TXT (Max 10MB)
                    </p>
                </div>
                <div class="upload-progress" id="uploadProgress"></div>
                <div class="uploaded-images" id="uploadedImages"></div>
            </div>
            <div class="upload-modal-footer" style="padding: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-success" id="saveImagesBtn" disabled>
                    <i class="fas fa-save"></i> Save to Project
                </button>
                <button class="btn btn-danger" id="cancelUploadBtn">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        class LifeDashboard {
            constructor() {
                this.currentPlan = null;
                this.currentSubPlan = null;
                this.editMode = false;
                this.modalMode = 'view';
                this.subPlanModalMode = 'view';
                this.reorderMode = false;
                this.uploadedImages = [];
                this.uploadedFiles = [];
                this.userData = {
                    xp: 1250,
                    level: 5,
                    achievements: [
                        { name: 'Early Bird', icon: '🌅', description: 'Complete 5 tasks before 9 AM' },
                        { name: 'Consistency King', icon: '👑', description: '30-day streak' }
                    ]
                };
                
                // Store all sub-plans data with hierarchy
                this.allPlansData = {};
                this.demoPlans = []; // Empty array - will be populated from API
                
                // API Base URL (empty for same origin)
                this.apiBaseUrl = '';
                
                this.init();
            }

            async init() {
                this.setupEventListeners();
                this.setupDragAndDrop();
                await this.fetchPlans(); // Fetch plans from backend
                this.showNotification('Welcome to Life Management Dashboard! 🎮', 'info');
            }

            // Updated fetchPlans to properly rebuild hierarchy
            async fetchPlans() {
                try {
                    const response = await fetch(`${this.apiBaseUrl}/api/plans`);
                    const result = await response.json();
                    if (result.success) {
                        const allPlans = result.data;
                        
                        // Clear existing data
                        this.allPlansData = {};
                        this.demoPlans = [];
                        
                        // First pass: Store all plans in map
                        allPlans.forEach(plan => {
                            // Ensure arrays exist
                            if (!plan.children) plan.children = [];
                            if (!plan.content) plan.content = [];
                            
                            // Store in map
                            this.allPlansData[plan.id] = plan;
                        });
                        
                        // Second pass: Build hierarchy and identify top-level plans
                        allPlans.forEach(plan => {
                            if (plan.parentId && plan.parentId !== 'null' && plan.parentId !== 'undefined') {
                                // Has parent, add to parent's children
                                const parentPlan = this.allPlansData[plan.parentId];
                                if (parentPlan) {
                                    if (!parentPlan.children.includes(plan.id)) {
                                        parentPlan.children.push(plan.id);
                                    }
                                }
                            } else {
                                // No parent or parent is null/undefined, top-level plan
                                this.demoPlans.push(plan);
                            }
                        });
                        
                        console.log('Fetched plans:', {
                            total: allPlans.length,
                            topLevel: this.demoPlans.length,
                            allPlansData: this.allPlansData
                        });
                        
                        this.renderPlans(this.demoPlans);
                    } else {
                        this.showNotification('Failed to load plans from server', 'error');
                        this.renderPlans([]);
                    }
                } catch (error) {
                    console.error('Error fetching plans:', error);
                    this.showNotification('Failed to connect to server', 'error');
                    this.renderPlans([]);
                }
            }

            setupEventListeners() {
                // Add Plan Button
                document.getElementById('addPlanBtn').addEventListener('click', () => this.showPlanCreation());
                
                // Main Modal Controls
                document.getElementById('modalCloseBtn').addEventListener('click', () => this.closeModal());
                document.getElementById('modalEditBtn').addEventListener('click', () => this.toggleModalEditMode());
                document.getElementById('reorderBtn').addEventListener('click', () => this.toggleReorderMode());
                document.getElementById('modalMenuBtn').addEventListener('click', () => {
                    this.toggleAddContentPanel();
                });
                
                // Generic Sub-Plan Modal Controls (reusable)
                document.getElementById('subPlanModalCloseBtn').addEventListener('click', () => this.closeSubPlanModal());
                document.getElementById('subPlanModalEditBtn').addEventListener('click', () => this.toggleCurrentModalEditMode());
                document.getElementById('subPlanModalMenuBtn').addEventListener('click', () => {
                    this.toggleAddContentPanel();
                });
                
                // Add Content Options
                document.querySelectorAll('.content-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        const type = e.target.closest('.content-option').dataset.type;
                        const isSubPlanModalOpen = document.getElementById('subPlanModalOverlay').style.display === 'flex';
                        
                        if (type === 'photo') {
                            this.openUploadModal();
                            return;
                        }
                        
                        if (isSubPlanModalOpen) {
                            this.showContentForm(type, true);
                        } else {
                            this.showContentForm(type, false);
                        }
                        
                        // Hide add content panel immediately when clicked
                        document.getElementById('addContentPanel').style.display = 'none';
                        this.removeBlurFromAllModals();
                    });
                });
                
                // Photo Upload Modal
                document.getElementById('closeUpload').addEventListener('click', () => this.closeUploadModal());
                document.getElementById('cancelUploadBtn').addEventListener('click', () => this.closeUploadModal());
                document.getElementById('browseBtn').addEventListener('click', () => document.getElementById('fileInput').click());
                document.getElementById('saveImagesBtn').addEventListener('click', () => this.saveImagesToPlan());
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileSelect(e));
                
                // Close modals on ESC key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        const addContentPanel = document.getElementById('addContentPanel');
                        if (addContentPanel.style.display === 'block') {
                            addContentPanel.style.display = 'none';
                            this.removeBlurFromAllModals();
                            return;
                        }
                        
                        if (document.getElementById('modalOverlay').style.display === 'flex') {
                            this.closeModal();
                        }
                        if (document.getElementById('subPlanModalOverlay').style.display === 'flex') {
                            this.closeSubPlanModal();
                        }
                        if (document.getElementById('uploadModal').style.display === 'flex') {
                            this.closeUploadModal();
                        }
                    }
                });
                
                // Close add content panel when clicking outside
                document.addEventListener('click', (e) => {
                    const addContentPanel = document.getElementById('addContentPanel');
                    const modalMenuBtn = document.getElementById('modalMenuBtn');
                    const subPlanModalMenuBtn = document.getElementById('subPlanModalMenuBtn');
                    
                    if (addContentPanel.style.display === 'block' &&
                        !addContentPanel.contains(e.target) &&
                        e.target !== modalMenuBtn &&
                        e.target !== subPlanModalMenuBtn &&
                        !modalMenuBtn.contains(e.target) &&
                        !subPlanModalMenuBtn.contains(e.target)) {
                        addContentPanel.style.display = 'none';
                        this.removeBlurFromAllModals();
                    }
                });
            }

            setupDragAndDrop() {
                const dropArea = document.getElementById('dropArea');
                
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, this.preventDefaults, false);
                    document.body.addEventListener(eventName, this.preventDefaults, false);
                });

                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => {
                        dropArea.classList.add('dragover');
                    }, false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => {
                        dropArea.classList.remove('dragover');
                    }, false);
                });

                dropArea.addEventListener('drop', (e) => {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    this.handleFiles(files);
                }, false);
            }

            preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            renderPlans(plans) {
                const container = document.getElementById('plansContainer');
                container.innerHTML = '';
                
                if (plans.length === 0) {
                    // Empty state as a plan card
                    container.innerHTML = `
                        <div class="plan-card empty-state-card">
                            <div class="empty-state">
                                <i class="fas fa-inbox empty-icon"></i>
                                <h3>No Plans Yet</h3>
                                <p>Click the + button to create your first plan!</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                plans.forEach(plan => {
                    const planCard = this.createPlanCard(plan);
                    container.appendChild(planCard);
                });
            }

            createPlanCard(plan) {
                const card = document.createElement('div');
                card.className = 'plan-card';
                card.dataset.id = plan.id;
                
                // Generate consistent ID instead of timestamp
                const planNumber = this.generatePlanNumber(plan.id);
                
                // Only show progress if progress > 0
                const progressHTML = plan.progress > 0 ? `
                    <div class="plan-progress show">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${plan.progress}%"></div>
                        </div>
                        <small>${plan.progress}% Complete</small>
                    </div>
                ` : '';
                
                // Photo display
                const photoHTML = plan.photo ? `
                    <div class="plan-card-photo">
                        <img src="${plan.photo}" alt="${plan.title}">
                    </div>
                ` : `
                    <div class="plan-card-photo">
                        <div class="plan-card-photo-placeholder">
                            <i class="fas fa-cube"></i>
                        </div>
                    </div>
                `;
                
                card.innerHTML = `
                    <div class="plan-card-header">
                        <div class="plan-card-header-left">
                            ${photoHTML}
                            <div class="plan-card-title">
                                <div class="plan-card-number">${planNumber}.</div>
                                <h3>${plan.title}</h3>
                            </div>
                        </div>
                        <div class="plan-actions">
                            <button class="icon-btn edit-btn" onclick="dashboard.editPlan('${plan.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="icon-btn close-btn" onclick="dashboard.deletePlan('${plan.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="plan-meta">
                        <span><i class="far fa-calendar"></i> ${new Date(plan.created_at).toLocaleDateString()}</span>
                        <span><i class="fas fa-list"></i> ${plan.content?.length || 0} items</span>
                    </div>
                    ${progressHTML}
                `;
                
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('.plan-actions')) {
                        this.openPlanModal(plan);
                    }
                });
                
                return card;
            }

            generatePlanNumber(planId) {
                // Simple consistent numbering system
                const planIndex = this.demoPlans.findIndex(p => p.id === planId);
                return (planIndex + 1).toString().padStart(3, '0');
            }

            showPlanCreation() {
                // Create a custom dialog for plan creation with photo upload
                this.showPlanCreationDialog();
            }

            showPlanCreationDialog() {
                const dialog = document.createElement('div');
                dialog.className = 'modal-overlay';
                dialog.style.display = 'flex';
                dialog.style.zIndex = '2500';
                
                const planNumber = (this.demoPlans.length + 1).toString().padStart(3, '0');
                
                dialog.innerHTML = `
                    <div class="modal" style="max-width: 500px;">
                        <div class="modal-header">
                            <h2><i class="fas fa-plus-circle"></i> Create New Plan</h2>
                            <button class="icon-btn close-btn" id="closePlanDialog">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-content">
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Plan Title *</label>
                                <input type="text" id="newPlanTitle" placeholder="Enter plan title" class="form-input" required>
                            </div>
                            
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Plan Photo (Optional)</label>
                                <div id="planPhotoPreview" style="width: 100px; height: 100px; border-radius: var(--radius); overflow: hidden; margin-bottom: 1rem; border: 2px solid var(--gray-300); display: flex; align-items: center; justify-content: center; background: var(--gray-100);">
                                    <div class="plan-card-photo-placeholder" style="width: 100%; height: 100%;">
                                        <i class="fas fa-camera"></i>
                                    </div>
                                </div>
                                <input type="file" id="planPhotoInput" accept="image/*" style="display: none;">
                                <button class="btn" id="uploadPlanPhotoBtn" style="width: 100%;">
                                    <i class="fas fa-upload"></i> Upload Photo
                                </button>
                            </div>
                            
                            <div style="margin-top: 2rem; padding: 1rem; background: var(--gray-100); border-radius: var(--radius);">
                                <div style="font-weight: 500; margin-bottom: 0.5rem;">Preview:</div>
                                <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: white; border-radius: var(--radius); border: 1px solid var(--gray-300);">
                                    <div id="planPreviewPhoto" style="width: 50px; height: 50px; border-radius: var(--radius); overflow: hidden; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; color: white;">
                                        <i class="fas fa-cube"></i>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.89775rem; color: var(--primary); font-weight: 500;">${planNumber}.</div>
                                        <div id="planPreviewTitle" style="font-weight: 600; color: var(--dark);">New Plan</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-actions" style="margin-top: 2rem;">
                                <button class="btn btn-success" id="createPlanBtn">
                                    <i class="fas fa-plus"></i> Create Plan
                                </button>
                                <button class="btn" id="cancelPlanBtn">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(dialog);
                
                // Add event listeners
                document.getElementById('closePlanDialog').addEventListener('click', () => dialog.remove());
                document.getElementById('cancelPlanBtn').addEventListener('click', () => dialog.remove());
                
                // Update preview when title changes
                document.getElementById('newPlanTitle').addEventListener('input', (e) => {
                    document.getElementById('planPreviewTitle').textContent = e.target.value || 'New Plan';
                });
                
                // Photo upload
                document.getElementById('uploadPlanPhotoBtn').addEventListener('click', () => {
                    document.getElementById('planPhotoInput').click();
                });
                
                document.getElementById('planPhotoInput').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const photoUrl = event.target.result;
                            document.getElementById('planPhotoPreview').innerHTML = `<img src="${photoUrl}" alt="Plan Photo" style="width: 100%; height: 100%; object-fit: cover;">`;
                            document.getElementById('planPreviewPhoto').innerHTML = `<img src="${photoUrl}" alt="Plan Photo" style="width: 100%; height: 100%; object-fit: cover;">`;
                        };
                        reader.readAsDataURL(file);
                    }
                });
                
                // Create plan
                document.getElementById('createPlanBtn').addEventListener('click', async () => {
                    const title = document.getElementById('newPlanTitle').value;
                    const photoPreview = document.querySelector('#planPhotoPreview img');
                    const photo = photoPreview ? photoPreview.src : null;
                    
                    if (!title.trim()) {
                        this.showNotification('Please enter plan title', 'warning');
                        return;
                    }
                    
                    await this.createPlan(title.trim(), photo);
                    dialog.remove();
                });
            }

            // Modified to use API with proper level
            async createPlan(title, photo = null) {
                // Create new plan structure with level 1 (top-level)
                const newPlan = {
                    title: title,
                    photo: photo,
                    created_at: new Date().toISOString(),
                    content: [],
                    children: [],
                    progress: 0,
                    level: 1, // Top-level plan
                    parentId: null // No parent for top-level plans
                };
                
                try {
                    const response = await fetch(`${this.apiBaseUrl}/api/plans`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(newPlan)
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        const createdPlan = result.data;
                        
                        // Add to demo plans and all plans data
                        this.demoPlans.push(createdPlan);
                        this.allPlansData[createdPlan.id] = createdPlan;
                        this.currentPlan = createdPlan;
                        
                        // Update UI
                        this.renderPlans(this.demoPlans);
                        this.openPlanModal(createdPlan);
                        this.showNotification(`"${title}" created successfully! 🎉`, 'success');
                    } else {
                        this.showNotification('Failed to create plan', 'error');
                    }
                } catch (error) {
                    console.error('Error creating plan:', error);
                    this.showNotification('Failed to connect to server', 'error');
                }
            }

            openPlanModal(plan) {
                this.currentPlan = plan;
                document.getElementById('modalTitle').textContent = plan.title;
                document.getElementById('modalOverlay').style.display = 'flex';
                
                this.renderModalContent(plan);
                
                // Show/hide reorder button
                const reorderBtn = document.getElementById('reorderBtn');
                reorderBtn.style.display = plan.content && plan.content.length > 1 ? 'inline-block' : 'none';
                
                // Hide add content panel
                document.getElementById('addContentPanel').style.display = 'none';
                this.removeBlurFromAllModals();
            }

            renderModalContent(plan) {
                const content = document.getElementById('modalContent');
                content.innerHTML = '';
                
                if (plan.content && plan.content.length > 0) {
                    plan.content.forEach((item, index) => {
                        const itemElement = this.createContentItem(item, index, false);
                        content.appendChild(itemElement);
                    });
                } else {
                    content.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-plus-circle empty-icon"></i>
                            <h3>No Content Yet</h3>
                            <p>Turn on Edit Mode and add content!</p>
                        </div>
                    `;
                }
            }

            // Generic method to open any sub-plan modal (works for unlimited levels)
            openSubPlanModal(subPlan) {
                if (!subPlan || !subPlan.id) {
                    this.showNotification('Invalid model', 'error');
                    return;
                }
                
                // Find the actual plan in allPlansData
                let actualPlan = this.allPlansData[subPlan.id];
                
                // If not found, try to find by different ID formats
                if (!actualPlan) {
                    console.log('Plan not found in allPlansData:', subPlan.id);
                    console.log('Available plans:', Object.keys(this.allPlansData));
                    
                    // Try alternate ID formats
                    const possibleIds = [
                        subPlan.id,
                        subPlan.id.toString(),
                        'model_' + subPlan.id,
                        subPlan.id.replace('model_', '')
                    ];
                    
                    for (const possibleId of possibleIds) {
                        if (this.allPlansData[possibleId]) {
                            actualPlan = this.allPlansData[possibleId];
                            console.log('Found plan with alternate ID:', possibleId);
                            break;
                        }
                    }
                }
                
                if (!actualPlan) {
                    this.showNotification('Model not properly initialized', 'error');
                    return;
                }
                
                this.currentSubPlan = actualPlan;
                document.getElementById('subPlanModalTitle').textContent = actualPlan.title;
                document.getElementById('subPlanModalOverlay').style.display = 'flex';
                
                this.renderSubPlanModalContent(actualPlan);
                
                // Hide add content panel
                document.getElementById('addContentPanel').style.display = 'none';
                this.removeBlurFromAllModals();
            }

            renderSubPlanModalContent(subPlan) {
                const content = document.getElementById('subPlanModalContent');
                content.innerHTML = '';
                
                // Show breadcrumb for hierarchy
                const breadcrumb = this.createBreadcrumb(subPlan.id);
                if (breadcrumb) {
                    content.appendChild(breadcrumb);
                }
                
                // Only show progress if progress > 0
                const progressHTML = subPlan.progress > 0 ? `
                    <div class="progress-tracker">
                        <div class="progress-tracker-header">
                            <h4>Progress: ${subPlan.progress}%</h4>
                            <div class="progress-circle">
                                <svg class="progress-circle-svg" viewBox="0 0 100 100">
                                    <circle class="progress-circle-bg" cx="50" cy="50" r="40"></circle>
                                    <circle class="progress-circle-fill" cx="50" cy="50" r="40" 
                                            style="--progress: ${subPlan.progress}"></circle>
                                </svg>
                                <div class="progress-circle-text">${subPlan.progress}%</div>
                            </div>
                        </div>
                    </div>
                ` : '';
                
                content.innerHTML += progressHTML;
                
                if (subPlan.content && subPlan.content.length > 0) {
                    subPlan.content.forEach((item, index) => {
                        const itemElement = this.createContentItem(item, index, true);
                        content.appendChild(itemElement);
                    });
                } else {
                    content.innerHTML += `
                        <div class="empty-state">
                            <i class="fas fa-plus-circle empty-icon"></i>
                            <h3>No Content Yet</h3>
                            <p>This model is empty</p>
                        </div>
                    `;
                }
            }

            createBreadcrumb(planId) {
                const plan = this.allPlansData[planId];
                if (!plan || plan.level <= 1) return null;
                
                const breadcrumbDiv = document.createElement('div');
                breadcrumbDiv.className = 'breadcrumb';
                breadcrumbDiv.style.marginBottom = '1rem';
                breadcrumbDiv.style.padding = '0.75rem';
                breadcrumbDiv.style.background = 'var(--gray-100)';
                breadcrumbDiv.style.borderRadius = 'var(--radius)';
                breadcrumbDiv.style.fontSize = '0.89775rem';
                
                // Build breadcrumb trail
                let trail = [];
                let currentPlan = plan;
                
                while (currentPlan && currentPlan.parentId && currentPlan.parentId !== 'null' && currentPlan.parentId !== 'undefined') {
                    const parentPlan = this.allPlansData[currentPlan.parentId];
                    if (parentPlan) {
                        trail.unshift({
                            id: parentPlan.id,
                            title: parentPlan.title
                        });
                        currentPlan = parentPlan;
                    } else {
                        break;
                    }
                }
                
                // Add current plan
                trail.push({
                    id: plan.id,
                    title: plan.title
                });
                
                breadcrumbDiv.innerHTML = trail.map((item, index) => {
                    if (index === trail.length - 1) {
                        return `<span style="color: var(--primary); font-weight: 500;">${item.title}</span>`;
                    } else {
                        return `<span style="cursor: pointer; color: var(--gray-600);" onclick="dashboard.openSubPlanModal(dashboard.allPlansData['${item.id}'])">${item.title}</span> <i class="fas fa-chevron-right" style="margin: 0 0.5rem; color: var(--gray-400); font-size: 0.7695rem;"></i>`;
                    }
                }).join('');
                
                return breadcrumbDiv;
            }

            createContentItem(item, index, isForSubPlan = false) {
                const itemDiv = document.createElement('div');
                
                if (item.type === 'progress') {
                    return this.renderProgressTrackerDirectly(item, isForSubPlan);
                }
                
                if (item.type === 'checkbox') {
                    return this.renderChecklistDirectly(item, isForSubPlan);
                }
                
                if (item.type === 'timeline') {
                    return this.renderTimelineDirectly(item, isForSubPlan);
                }
                
                itemDiv.className = `content-item ${item.type}-item`;
                itemDiv.dataset.id = item.id;
                itemDiv.dataset.index = index;
                
                if (!isForSubPlan && this.reorderMode) {
                    itemDiv.draggable = true;
                }
                
                const typeConfig = this.getTypeConfig(item.type);
                const isSubPlanModal = document.getElementById('subPlanModalOverlay').style.display === 'flex';
                const currentEditMode = isSubPlanModal ? this.subPlanModalMode : this.modalMode;
                
                itemDiv.innerHTML = `
                    <div class="content-item-header">
                        <div class="content-item-type">
                            <i class="${typeConfig.icon}"></i>
                            <span>${typeConfig.name}</span>
                            ${!isForSubPlan && this.reorderMode ? '<span class="drag-handle"><i class="fas fa-arrows-alt"></i></span>' : ''}
                        </div>
                        ${currentEditMode === 'edit' && !this.reorderMode ? `
                            <div class="content-item-actions">
                                <button class="icon-btn edit-btn" onclick="dashboard.showEditForm('${item.id}', ${isForSubPlan})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="icon-btn close-btn" onclick="dashboard.deleteContentItem('${item.id}', ${isForSubPlan})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    <div class="content-item-body">
                        ${this.renderContentBody(item, isForSubPlan)}
                    </div>
                `;
                
                if (!isForSubPlan && this.reorderMode) {
                    itemDiv.addEventListener('dragstart', (e) => this.handleDragStart(e, itemDiv));
                    itemDiv.addEventListener('dragover', (e) => this.handleDragOver(e, itemDiv));
                    itemDiv.addEventListener('drop', (e) => this.handleDrop(e, itemDiv));
                    itemDiv.addEventListener('dragend', (e) => this.handleDragEnd(e, itemDiv));
                }
                
                // Make model items clickable to open sub-plan (for all levels)
                if (item.type === 'model') {
                    itemDiv.style.cursor = 'pointer';
                    itemDiv.addEventListener('click', (e) => {
                        if (!e.target.closest('.model-card-actions') && 
                            !e.target.closest('.content-item-actions') && 
                            !this.reorderMode) {
                            
                            const subPlanId = item.id;
                            console.log('Clicked model with ID:', subPlanId);
                            
                            // Find the plan in allPlansData
                            let subPlan = this.allPlansData[subPlanId];
                            
                            // Try alternate ID formats if not found
                            if (!subPlan) {
                                const possibleIds = [
                                    subPlanId,
                                    subPlanId.toString(),
                                    'model_' + subPlanId,
                                    subPlanId.replace('model_', '')
                                ];
                                
                                for (const possibleId of possibleIds) {
                                    if (this.allPlansData[possibleId]) {
                                        subPlan = this.allPlansData[possibleId];
                                        console.log('Found model with alternate ID:', possibleId);
                                        break;
                                    }
                                }
                            }
                            
                            if (subPlan) {
                                this.openSubPlanModal(subPlan);
                            } else {
                                console.log('Model not found in allPlansData:', subPlanId);
                                console.log('Available plans:', Object.keys(this.allPlansData));
                                this.showNotification('Model not properly initialized', 'error');
                            }
                        }
                    });
                }
                
                return itemDiv;
            }

            // Modified to use API with correct hierarchy
            async addModel(formId, isForSubPlan = false) {
                const suffix = isForSubPlan ? 'SubPlan' : '';
                const title = document.getElementById(`modelTitle${suffix}`).value;
                const description = document.getElementById(`modelDescription${suffix}`).value;
                
                if (!title.trim()) {
                    this.showNotification('Please enter a model title', 'warning');
                    return;
                }
                
                // Get parent plan
                let parentPlan;
                if (isForSubPlan) {
                    parentPlan = this.currentSubPlan;
                } else {
                    parentPlan = this.currentPlan;
                }
                
                if (!parentPlan) {
                    this.showNotification('No parent plan found', 'error');
                    return;
                }
                
                // Get photo if uploaded
                const photoPreview = document.querySelector(`#modelPhotoPreview${suffix} img`);
                const photo = photoPreview ? photoPreview.src : null;
                
                // Create unique ID
                const newModelId = 'model_' + Date.now().toString();
                
                // Create model item for parent's content array
                const modelContentItem = {
                    id: newModelId,
                    type: 'model',
                    data: { 
                        title: title, 
                        description: description 
                    },
                    created_at: new Date().toISOString()
                };
                
                // Create sub-plan structure with proper parent relationship
                const newSubPlan = {
                    id: newModelId,
                    title: title,
                    photo: photo,
                    description: description,
                    created_at: new Date().toISOString(),
                    content: [],
                    children: [],
                    progress: 0,
                    level: (parentPlan.level || 1) + 1,
                    parentId: parentPlan.id,  // CRITICAL: Set parent ID
                    user_id: 'anonymous'
                };
                
                try {
                    // Step 1: Create sub-plan in database
                    const planResponse = await fetch(`${this.apiBaseUrl}/api/plans`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(newSubPlan)
                    });
                    
                    const planResult = await planResponse.json();
                    if (!planResult.success) {
                        throw new Error('Failed to create sub-plan');
                    }
                    
                    const createdSubPlan = planResult.data;
                    
                    // Store in allPlansData with exact same ID
                    this.allPlansData[createdSubPlan.id] = createdSubPlan;
                    
                    // Step 2: Add model content to parent plan
                    const contentResponse = await fetch(`${this.apiBaseUrl}/api/plans/${parentPlan.id}/content`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(modelContentItem)
                    });
                    
                    const contentResult = await contentResponse.json();
                    if (!contentResult.success) {
                        throw new Error('Failed to add content to parent');
                    }
                    
                    // Step 3: Update parent's children array
                    if (!parentPlan.children) {
                        parentPlan.children = [];
                    }
                    if (!parentPlan.children.includes(createdSubPlan.id)) {
                        parentPlan.children.push(createdSubPlan.id);
                    }
                    
                    // Step 4: Update parent in database
                    await fetch(`${this.apiBaseUrl}/api/plans/${parentPlan.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            children: parentPlan.children 
                        })
                    });
                    
                    // Step 5: Add to parent's content array locally
                    if (!parentPlan.content) {
                        parentPlan.content = [];
                    }
                    parentPlan.content.push(contentResult.data);
                    
                    // Log for debugging
                    console.log('Parent plan updated:', parentPlan);
                    console.log('Child plan created:', createdSubPlan);
                    console.log('Child stored in allPlansData:', this.allPlansData[createdSubPlan.id]);
                    
                    // Re-render
                    if (isForSubPlan) {
                        this.renderSubPlanModalContent(parentPlan);
                    } else {
                        this.renderModalContent(parentPlan);
                    }
                    
                    this.hideContentForm(formId);
                    this.showNotification('Model added successfully! 🎯', 'success');
                    
                } catch (error) {
                    console.error('Error adding model:', error);
                    this.showNotification('Failed to add model: ' + error.message, 'error');
                }
            }

            // FIXED: Render Progress Tracker directly without blue outer card
            renderProgressTrackerDirectly(item, isForSubPlan = false) {
                const progress = item.data.target > 0 ? (item.data.current / item.data.target * 100) : 0;
                const statusColors = {
                    'on-track': '#10b981',
                    'delayed': '#f59e0b',
                    'ahead': '#3b82f6',
                    'completed': '#8b5cf6',
                    'not-started': '#6b7280'
                };
                const statusColor = statusColors[item.data.status] || '#6b7280';
                
                const isSubPlanModal = document.getElementById('subPlanModalOverlay').style.display === 'flex';
                const currentEditMode = isSubPlanModal ? this.subPlanModalMode : this.modalMode;
                
                const progressDiv = document.createElement('div');
                progressDiv.className = 'progress-tracker';
                progressDiv.dataset.id = item.id;
                
                let editActions = '';
                if (currentEditMode === 'edit') {
                    editActions = `
                        <div class="content-item-actions" style="display: flex; gap: 0.5rem;">
                            <button class="icon-btn edit-btn" onclick="dashboard.showEditForm('${item.id}', ${isForSubPlan})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="icon-btn close-btn" onclick="dashboard.deleteContentItem('${item.id}', ${isForSubPlan})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                }
                
                progressDiv.innerHTML = `
                    <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="color: var(--dark); font-size: 1.15425rem; font-weight: 600; margin-bottom: 0.25rem;">${item.data.title || 'Progress Tracker'}</h4>
                            ${item.data.startDate || item.data.endDate ? `
                                <div style="font-size: 0.85rem; color: var(--gray-500); display: flex; align-items: center; gap: 0.5rem;">
                                    ${item.data.startDate ? `<span><i class="far fa-calendar"></i> ${item.data.startDate}</span>` : ''}
                                    ${item.data.startDate && item.data.endDate ? '→' : ''}
                                    ${item.data.endDate ? `<span><i class="far fa-calendar"></i> ${item.data.endDate}</span>` : ''}
                                </div>
                            ` : ''}
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: ${statusColor}20; color: ${statusColor}; border-radius: var(--radius); font-weight: 500; font-size: 0.9rem;">
                                <i class="fas fa-circle" style="font-size: 0.6rem;"></i>
                                ${item.data.status ? item.data.status.charAt(0).toUpperCase() + item.data.status.slice(1).replace('-', ' ') : 'On Track'}
                            </div>
                            ${editActions}
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div class="progress-circle" style="width: 82.08px; height: 82.08px;">
                            <svg class="progress-circle-svg" viewBox="0 0 100 100">
                                <circle class="progress-circle-bg" cx="50" cy="50" r="40"></circle>
                                <circle class="progress-circle-fill" cx="50" cy="50" r="40" 
                                        style="--progress: ${progress}; stroke: ${statusColor}"></circle>
                            </svg>
                            <div class="progress-circle-text">${Math.round(progress)}%</div>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 1.2rem; font-weight: 600; color: var(--dark); margin-bottom: 0.25rem;">
                                ${item.data.current} / ${item.data.target} ${item.data.unit || ''}
                            </div>
                            <div class="progress-bar" style="margin-top: 0.75rem; height: 6px; background: var(--gray-200); border-radius: 3px; overflow: hidden;">
                                <div class="progress-fill" style="height: 100%; background: linear-gradient(90deg, ${statusColor}, ${statusColor}80); border-radius: 3px; width: ${progress}%;"></div>
                            </div>
                        </div>
                    </div>
                    
                    ${item.data.milestones && item.data.milestones.length > 0 ? `
                        <div style="margin-top: 1.5rem;">
                            <h5 style="color: var(--dark); font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem;">Milestones</h5>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${item.data.milestones.map((milestone, idx) => `
                                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: ${milestone.completed ? '#10b98120' : '#f3f4f6'}; border-radius: var(--radius); border: 1px solid ${milestone.completed ? '#10b98140' : '#e5e7eb'};">
                                        <div style="width: 20px; height: 20px; border-radius: 50%; background: ${milestone.completed ? '#10b981' : '#e5e7eb'}; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.6rem;">
                                            ${milestone.completed ? '✓' : (idx + 1)}
                                        </div>
                                        <div>
                                            <div style="font-size: 0.85rem; font-weight: 500; color: var(--dark);">${milestone.label}</div>
                                            <div style="font-size: 0.75rem; color: var(--gray-500);">${milestone.value} ${item.data.unit || ''}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${item.data.notes ? `
                        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                            <h5 style="color: var(--dark); font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">Notes</h5>
                            <div style="padding: 0.75rem; background: #f8fafc; border-radius: var(--radius); font-size: 0.9rem; color: var(--gray-700); line-height: 1.5;">
                                ${item.data.notes}
                            </div>
                        </div>
                    ` : ''}
                `;
                
                return progressDiv;
            }

            // FIXED: Render checklist directly without blue outer card
            renderChecklistDirectly(item, isForSubPlan = false) {
                const checklistDiv = document.createElement('div');
                checklistDiv.className = 'improved-checklist';
                checklistDiv.dataset.id = item.id;
                
                // Add inside-model class if inside a model
                if (this.currentSubPlan || this.currentPlan?.level > 1) {
                    checklistDiv.classList.add('inside-model');
                }
                
                const isSubPlanModal = document.getElementById('subPlanModalOverlay').style.display === 'flex';
                const currentEditMode = isSubPlanModal ? this.subPlanModalMode : this.modalMode;
                
                // Ensure tasks array exists
                if (!item.data.tasks) {
                    item.data.tasks = [];
                }
                
                if (item.data.tasks.length > 0) {
                    const total = item.data.tasks.length;
                    const completed = item.data.tasks.filter(t => t.completed).length;
                    const progress = total > 0 ? Math.round((completed / total) * 100) : 0;
                    
                    checklistDiv.innerHTML = `
                        <div class="checklist-header">
                            <div class="checklist-title">
                                <i class="fas fa-tasks"></i>
                                <span>Checklist</span>
                            </div>
                            <div class="checklist-stats">
                                ${completed}/${total} completed (${progress}%)
                            </div>
                            ${currentEditMode === 'edit' ? `
                                <div class="content-item-actions" style="display: flex; gap: 0.5rem;">
                                    <button class="icon-btn edit-btn" onclick="dashboard.showEditForm('${item.id}', ${isForSubPlan})" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="icon-btn close-btn" onclick="dashboard.deleteContentItem('${item.id}', ${isForSubPlan})" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                        <div class="checklist-tasks">
                            ${item.data.tasks.map((task, idx) => `
                                <div class="checklist-task ${task.completed ? 'completed' : ''}">
                                    <input type="checkbox" ${task.completed ? 'checked' : ''} 
                                           onchange="dashboard.updateCheckbox('${item.id}', ${idx}, this.checked, ${isForSubPlan})"
                                           id="task-${item.id}-${idx}">
                                    <label for="task-${item.id}-${idx}">
                                        ${task.text}
                                    </label>
                                    ${currentEditMode === 'edit' ? `
                                        <div class="task-actions">
                                            <button class="icon-btn edit-btn" onclick="dashboard.editTask('${item.id}', ${idx}, ${isForSubPlan})" title="Edit Task">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    checklistDiv.innerHTML = `
                        <div class="checklist-header">
                            <div class="checklist-title">
                                <i class="fas fa-tasks"></i>
                                <span>Checklist</span>
                            </div>
                            ${currentEditMode === 'edit' ? `
                                <div class="content-item-actions" style="display: flex; gap: 0.5rem;">
                                    <button class="icon-btn edit-btn" onclick="dashboard.showEditForm('${item.id}', ${isForSubPlan})" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="icon-btn close-btn" onclick="dashboard.deleteContentItem('${item.id}', ${isForSubPlan})" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                        <p style="color: var(--gray-500); font-style: italic; padding: 1rem; text-align: center;">No tasks added yet</p>
                    `;
                }
                
                return checklistDiv;
            }

            // FIXED: Render timeline directly without blue outer card
            renderTimelineDirectly(item, isForSubPlan = false) {
                const timelineDiv = document.createElement('div');
                timelineDiv.className = 'timeline-content';
                timelineDiv.dataset.id = item.id;
                
                const isSubPlanModal = document.getElementById('subPlanModalOverlay').style.display === 'flex';
                const currentEditMode = isSubPlanModal ? this.subPlanModalMode : this.modalMode;
                
                const statusColor = this.getStatusColor(item.data.status || 'planned');
                
                timelineDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <i class="fas fa-calendar-alt" style="color: var(--warning); font-size: 1.2rem;"></i>
                            <h4 style="margin: 0; color: var(--dark); font-weight: 600;">Timeline</h4>
                        </div>
                        ${currentEditMode === 'edit' ? `
                            <div class="content-item-actions" style="display: flex; gap: 0.5rem;">
                                <button class="icon-btn edit-btn" onclick="dashboard.showEditForm('${item.id}', ${isForSubPlan})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="icon-btn close-btn" onclick="dashboard.deleteContentItem('${item.id}', ${isForSubPlan})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    <div class="timeline-details">
                        <div class="timeline-dates">
                            <span><i class="far fa-calendar"></i> ${item.data.startDate || 'Start Date'}</span>
                            <i class="fas fa-arrow-right timeline-arrow"></i>
                            <span><i class="far fa-calendar"></i> ${item.data.endDate || 'End Date'}</span>
                        </div>
                        ${item.data.description ? `
                            <div style="margin-bottom: 1rem; color: var(--gray-700); line-height: 1.6;">
                                ${item.data.description}
                            </div>
                        ` : ''}
                        ${item.data.status ? `
                            <div style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: ${statusColor}20; color: ${statusColor}; border-radius: var(--radius); font-weight: 500; font-size: 0.9rem;">
                                <i class="fas fa-circle" style="font-size: 0.6rem;"></i>
                                ${item.data.status.charAt(0).toUpperCase() + item.data.status.slice(1)}
                            </div>
                        ` : ''}
                    </div>
                `;
                
                return timelineDiv;
            }

            getTypeConfig(type) {
                const configs = {
                    'model': { icon: 'fas fa-cube', name: 'Model' },
                    'photo': { icon: 'fas fa-images', name: 'Photos' },
                    'description': { icon: 'fas fa-sticky-note', name: 'Description' },
                    'checkbox': { icon: 'fas fa-tasks', name: 'Checklist' },
                    'timeline': { icon: 'fas fa-calendar-alt', name: 'Timeline' },
                    'priority': { icon: 'fas fa-flag', name: 'Tags' },
                    'link': { icon: 'fas fa-link', name: 'Links' },
                    'progress': { icon: 'fas fa-chart-line', name: 'Progress Tracker' },
                    'kanban': { icon: 'fas fa-columns', name: 'Kanban Board' },
                    'swot': { icon: 'fas fa-th-large', name: 'SWOT Analysis' }
                };
                return configs[type] || { icon: 'fas fa-question', name: 'Item' };
            }

            renderContentBody(item, isForSubPlan = false) {
                const isSubPlanModal = document.getElementById('subPlanModalOverlay').style.display === 'flex';
                
                switch(item.type) {
                    case 'model':
                        // Find the model plan in allPlansData
                        let modelPlan = this.allPlansData[item.id];
                        
                        // Try alternate ID formats if not found
                        if (!modelPlan) {
                            const possibleIds = [
                                item.id,
                                item.id.toString(),
                                'model_' + item.id,
                                item.id.replace('model_', '')
                            ];
                            
                            for (const possibleId of possibleIds) {
                                if (this.allPlansData[possibleId]) {
                                    modelPlan = this.allPlansData[possibleId];
                                    console.log('Found model with alternate ID:', possibleId);
                                    break;
                                }
                            }
                        }
                        
                        const modelLevel = modelPlan?.level || 2;
                        const levelClass = `level-${modelLevel > 6 ? 6 : modelLevel}`;
                        const itemCount = (modelPlan?.content?.length || 0) + (modelPlan?.children?.length || 0);
                        
                        // Photo display for model
                        const photoHTML = modelPlan?.photo ? `
                            <div class="model-card-photo">
                                <img src="${modelPlan.photo}" alt="${item.data.title || 'New Model'}">
                            </div>
                        ` : `
                            <div class="model-card-photo">
                                <div class="model-card-photo-placeholder">
                                    <i class="fas fa-cube"></i>
                                </div>
                            </div>
                        `;
                        
                        return `
                            <div class="model-card ${levelClass}" data-id="${item.id}">
                                <div class="model-card-content">
                                    <div class="model-card-header">
                                        ${photoHTML}
                                        <div class="model-card-title-section">
                                            <h4>${item.data.title || 'New Model'}</h4>
                                            ${item.data.description ? `
                                                <div class="model-card-description">
                                                    ${item.data.description}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div class="model-card-meta">
                                        <div class="model-card-stats">
                                            <span><i class="fas fa-cube"></i> Level ${modelLevel}</span>
                                            <span><i class="fas fa-list"></i> ${itemCount} items</span>
                                            ${modelPlan?.progress > 0 ? `<span><i class="fas fa-chart-line"></i> ${modelPlan.progress}%</span>` : ''}
                                            <span><i class="far fa-calendar"></i> ${new Date(item.created_at).toLocaleDateString()}</span>
                                        </div>
                                        ${(isSubPlanModal ? this.subPlanModalMode : this.modalMode) === 'edit' && !this.reorderMode ? `
                                            <div class="model-card-actions">
                                                <button class="model-card-action-btn edit-btn" onclick="event.stopPropagation(); dashboard.showEditForm('${item.id}', ${isForSubPlan})" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="model-card-action-btn close-btn" onclick="event.stopPropagation(); dashboard.deleteContentItem('${item.id}', ${isForSubPlan})" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        ` : ''}
                                    </div>
                                    ${modelPlan?.progress > 0 ? `
                                        <div class="model-progress">
                                            <div class="model-progress-bar">
                                                <div class="model-progress-fill" style="width: ${modelPlan.progress}%"></div>
                                            </div>
                                            <div class="model-progress-text">${modelPlan.progress}% Complete</div>
                                        </div>
                                    ` : ''}
                                    <div style="margin-top: 0.75rem; font-size: 0.8rem; opacity: 0.9;">
                                        <i class="fas fa-mouse-pointer"></i> Click to open model
                                    </div>
                                </div>
                            </div>
                        `;
                        
                    case 'description':
                        return `
                            <div class="description-content">${item.data.text || ''}</div>
                        `;
                        
                    case 'checkbox':
                        return '';
                        
                    case 'timeline':
                        return '';
                        
                    case 'priority':
                        if (item.data.tags && item.data.tags.length > 0) {
                            return item.data.tags.map(tag => `
                                <span class="priority-item">
                                    <i class="fas fa-tag"></i> ${tag}
                                </span>
                            `).join('');
                        }
                        return '<p style="color: var(--gray-500); font-style: italic;">No tags added</p>';
                        
                    case 'link':
                        if (item.data.links && item.data.links.length > 0) {
                            return item.data.links.map((link, index) => {
                                const icon = this.getLinkIcon(link.type || 'website');
                                const safeUrl = link.url || '#';
                                const target = safeUrl.startsWith('http') ? '_blank' : '_self';
                                const rel = target === '_blank' ? 'noopener noreferrer' : '';
                                
                                return `
                                    <a href="${safeUrl}" target="${target}" rel="${rel}" class="link-preview">
                                        <div class="link-icon">
                                            <i class="${icon}"></i>
                                        </div>
                                        <div class="link-content">
                                            <h4>${link.title || 'Untitled Link'}</h4>
                                            <div class="link-url">${safeUrl}</div>
                                            ${link.description ? `<div class="link-description">${link.description}</div>` : ''}
                                            <span class="link-type-badge">${link.type || 'Website'}</span>
                                        </div>
                                    </a>
                                `;
                            }).join('');
                        }
                        return '<p style="color: var(--gray-500); font-style: italic;">No links added</p>';
                        
                    case 'kanban':
                        return `
                            <div class="kanban-board">
                                ${item.data.columns.map((column, colIndex) => `
                                    <div class="kanban-column">
                                        <div class="kanban-column-header">
                                            <div class="kanban-column-title">${column.name}</div>
                                            <span style="font-size: 0.7695rem; color: var(--gray-500);">${column.tasks.length}${column.limit ? '/' + column.limit : ''}</span>
                                        </div>
                                        ${column.tasks.map((task, taskIndex) => `
                                            <div class="kanban-task" draggable="true">
                                                ${task}
                                            </div>
                                        `).join('')}
                                        ${(this.subPlanModalMode === 'edit' || this.modalMode === 'edit') ? `
                                            <button class="btn" style="width: 100%; margin-top: 0.5rem; padding: 0.5rem;" 
                                                    onclick="dashboard.addKanbanTask('${item.id}', ${colIndex}, ${isForSubPlan})">
                                                <i class="fas fa-plus"></i> Add Task
                                            </button>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        
                    case 'swot':
                        return `
                            <div class="swot-grid">
                                <div class="swot-quadrant swot-strengths">
                                    <h5>Strengths</h5>
                                    ${(item.data.strengths || []).map(s => `
                                        <div class="swot-item">${s}</div>
                                    `).join('')}
                                    ${item.data.strengths && item.data.strengths.length === 0 ? '<div style="color: var(--gray-500); font-style: italic; font-size: 0.875rem;">No strengths added</div>' : ''}
                                </div>
                                <div class="swot-quadrant swot-weaknesses">
                                    <h5>Weaknesses</h5>
                                    ${(item.data.weaknesses || []).map(w => `
                                        <div class="swot-item">${w}</div>
                                    `).join('')}
                                    ${item.data.weaknesses && item.data.weaknesses.length === 0 ? '<div style="color: var(--gray-500); font-style: italic; font-size: 0.875rem;">No weaknesses added</div>' : ''}
                                </div>
                                <div class="swot-quadrant swot-opportunities">
                                    <h5>Opportunities</h5>
                                    ${(item.data.opportunities || []).map(o => `
                                        <div class="swot-item">${o}</div>
                                    `).join('')}
                                    ${item.data.opportunities && item.data.opportunities.length === 0 ? '<div style="color: var(--gray-500); font-style: italic; font-size: 0.875rem;">No opportunities added</div>' : ''}
                                </div>
                                <div class="swot-quadrant swot-threats">
                                    <h5>Threats</h5>
                                    ${(item.data.threats || []).map(t => `
                                        <div class="swot-item">${t}</div>
                                    `).join('')}
                                    ${item.data.threats && item.data.threats.length === 0 ? '<div style="color: var(--gray-500); font-style: italic; font-size: 0.875rem;">No threats added</div>' : ''}
                                </div>
                            </div>
                        `;
                        
                    case 'progress':
                        return '';
                        
                    case 'photo':
                        if (item.data.images && item.data.images.length > 0) {
                            return `
                                <div class="photo-gallery">
                                    ${item.data.images.map(img => `
                                        <div class="photo-item">
                                            <img src="${img.preview || img.url}" alt="${img.name}" 
                                                 style="width: 150px; height: 150px; object-fit: cover; border-radius: var(--radius);">
                                            <div style="font-size: 0.7695rem; color: var(--gray-600); text-align: center; margin-top: 0.5rem;">
                                                ${img.name.length > 15 ? img.name.substring(0, 15) + '...' : img.name}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }
                        return '<p style="color: var(--gray-500); font-style: italic;">No photos added</p>';
                        
                    default:
                        return `<pre style="background: var(--gray-100); padding: 1rem; border-radius: var(--radius); overflow: auto;">${JSON.stringify(item.data, null, 2)}</pre>`;
                }
            }

            editTask(contentId, taskIndex, isForSubPlan = false) {
                let contentArray;
                if (isForSubPlan) {
                    contentArray = this.currentSubPlan.content;
                } else {
                    contentArray = this.currentPlan.content;
                }
                
                const contentItem = contentArray.find(item => item.id === contentId);
                
                if (contentItem && contentItem.data.tasks[taskIndex]) {
                    const newText = prompt('Edit task:', contentItem.data.tasks[taskIndex].text);
                    if (newText && newText.trim()) {
                        contentItem.data.tasks[taskIndex].text = newText.trim();
                        
                        if (isForSubPlan) {
                            this.renderSubPlanModalContent(this.currentSubPlan);
                        } else {
                            this.renderModalContent(this.currentPlan);
                        }
                        
                        this.showNotification('Task updated! ✏️', 'success');
                    }
                }
            }

            getStatusColor(status) {
                const colors = {
                    'planned': '#3b82f6',
                    'in-progress': '#f59e0b',
                    'completed': '#10b981',
                    'on-hold': '#6b7280',
                    'cancelled': '#ef4444'
                };
                return colors[status] || '#6b7280';
            }

            getLinkIcon(linkType) {
                const icons = {
                    'video': 'fas fa-video',
                    'article': 'fas fa-newspaper',
                    'documentation': 'fas fa-book',
                    'resource': 'fas fa-box-open',
                    'website': 'fas fa-globe',
                    'tool': 'fas fa-tools',
                    'other': 'fas fa-link'
                };
                return icons[linkType] || 'fas fa-link';
            }

            showContentForm(type, isForSubPlan = false) {
                const form = this.getContentForm(type, isForSubPlan);
                if (form) {
                    let modalContent;
                    if (isForSubPlan) {
                        modalContent = document.getElementById('subPlanModalContent');
                    } else {
                        modalContent = document.getElementById('modalContent');
                    }
                    
                    // Remove any existing form
                    const existingForm = modalContent.querySelector('.content-form');
                    if (existingForm) existingForm.remove();
                    
                    modalContent.insertBefore(form, modalContent.firstChild);
                    form.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }

            showEditForm(contentId, isForSubPlan = false) {
                // Find the content item
                let contentArray, contentItem;
                
                if (isForSubPlan) {
                    contentArray = this.currentSubPlan.content;
                } else {
                    contentArray = this.currentPlan.content;
                }
                
                contentItem = contentArray.find(item => item.id === contentId);
                
                if (!contentItem) {
                    this.showNotification('Content not found', 'error');
                    return;
                }
                
                const form = this.getEditForm(contentItem, isForSubPlan);
                if (form) {
                    let modalContent;
                    if (isForSubPlan) {
                        modalContent = document.getElementById('subPlanModalContent');
                    } else {
                        modalContent = document.getElementById('modalContent');
                    }
                    
                    // Remove any existing form
                    const existingForm = modalContent.querySelector('.content-form');
                    if (existingForm) existingForm.remove();
                    
                    modalContent.insertBefore(form, modalContent.firstChild);
                    form.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }

            getContentForm(type, isForSubPlan = false) {
                const form = document.createElement('div');
                form.className = 'content-form';
                
                const formId = `form-${Date.now()}`;
                form.id = formId;
                
                const formSuffix = isForSubPlan ? 'SubPlan' : '';
                
                switch(type) {
                    case 'model':
                        form.innerHTML = `
                            <div class="form-header">
                                <h4><i class="fas fa-cube"></i> Add New Model</h4>
                                <button class="form-close-btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="form-group">
                                <input type="text" id="modelTitle${formSuffix}" placeholder="Model Title *" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <textarea id="modelDescription${formSuffix}" placeholder="Model Description (Optional)" 
                                          class="form-input" rows="3"></textarea>
                            </div>
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Model Photo (Optional)</label>
                                <div id="modelPhotoPreview${formSuffix}" style="width: 80px; height: 80px; border-radius: var(--radius); overflow: hidden; margin-bottom: 1rem; border: 2px solid var(--gray-300); display: flex; align-items: center; justify-content: center; background: var(--gray-100);">
                                    <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: var(--gray-500);">
                                        <i class="fas fa-camera"></i>
                                    </div>
                                </div>
                                <input type="file" id="modelPhotoInput${formSuffix}" accept="image/*" style="display: none;">
                                <button class="btn" id="uploadModelPhotoBtn${formSuffix}" style="width: 100%;">
                                    <i class="fas fa-upload"></i> Upload Photo
                                </button>
                            </div>
                            <div style="margin-bottom: 1rem; padding: 0.75rem; background: var(--gray-100); border-radius: var(--radius); font-size: 0.89775rem;">
                                <i class="fas fa-info-circle" style="color: var(--info); margin-right: 0.5rem;"></i>
                                This will create a nested model with unlimited hierarchy levels.
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-success" onclick="dashboard.addModel('${formId}', ${isForSubPlan})">
                                    <i class="fas fa-plus"></i> Add Model
                                </button>
                                <button class="btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        `;
                        
                        // Add photo upload functionality
                        setTimeout(() => {
                            const photoInput = document.getElementById(`modelPhotoInput${formSuffix}`);
                            const uploadBtn = document.getElementById(`uploadModelPhotoBtn${formSuffix}`);
                            const preview = document.getElementById(`modelPhotoPreview${formSuffix}`);
                            
                            uploadBtn.addEventListener('click', () => {
                                photoInput.click();
                            });
                            
                            photoInput.addEventListener('change', (e) => {
                                const file = e.target.files[0];
                                if (file) {
                                    const reader = new FileReader();
                                    reader.onload = (event) => {
                                        preview.innerHTML = `<img src="${event.target.result}" alt="Model Photo" style="width: 100%; height: 100%; object-fit: cover;">`;
                                    };
                                    reader.readAsDataURL(file);
                                }
                            });
                        }, 100);
                        break;
                        
                    case 'description':
                        form.innerHTML = `
                            <div class="form-header">
                                <h4><i class="fas fa-sticky-note"></i> Add Description</h4>
                                <button class="form-close-btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="form-group">
                                <textarea id="descriptionText${formSuffix}" placeholder="Enter description..." 
                                          class="form-input" rows="5" required></textarea>
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-success" onclick="dashboard.addDescription('${formId}', ${isForSubPlan})">
                                    <i class="fas fa-plus"></i> Add Description
                                </button>
                                <button class="btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        `;
                        break;
                        
                    case 'checkbox':
                        form.innerHTML = `
                            <div class="form-header">
                                <h4><i class="fas fa-tasks"></i> Add Checklist Item</h4>
                                <button class="form-close-btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="form-group">
                                <input type="text" id="taskText${formSuffix}" placeholder="Task description *" 
                                       class="form-input" required>
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-success" onclick="dashboard.addChecklistItem('${formId}', ${isForSubPlan})">
                                    <i class="fas fa-plus"></i> Add Task
                                </button>
                                <button class="btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        `;
                        break;
                        
                    case 'timeline':
                        const today = new Date().toISOString().split('T')[0];
                        const nextMonth = new Date(Date.now() + 30 * 86400000).toISOString().split('T')[0];
                        form.innerHTML = `
                            <div class="form-header">
                                <h4><i class="fas fa-calendar-alt"></i> Add Timeline</h4>
                                <button class="form-close-btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Start Date</label>
                                    <input type="date" id="timelineStart${formSuffix}" class="form-input" value="${today}">
                                </div>
                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">End Date</label>
                                    <input type="date" id="timelineEnd${formSuffix}" class="form-input" value="${nextMonth}">
                                </div>
                            </div>
                            <div class="form-group">
                                <textarea id="timelineDesc${formSuffix}" placeholder="Timeline description" 
                                          class="form-input" rows="3"></textarea>
                            </div>
                            <div class="form-group">
                                <select id="timelineStatus${formSuffix}" class="form-input">
                                    <option value="planned">Planned</option>
                                    <option value="in-progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                    <option value="on-hold">On Hold</option>
                                </select>
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-success" onclick="dashboard.addTimeline('${formId}', ${isForSubPlan})">
                                    <i class="fas fa-plus"></i> Add Timeline
                                </button>
                                <button class="btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        `;
                        break;
                        
                    case 'priority':
                        form.innerHTML = `
                            <div class="form-header">
                                <h4><i class="fas fa-flag"></i> Add Priority Tag</h4>
                                <button class="form-close-btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="form-group">
                                <input type="text" id="tagText${formSuffix}" placeholder="Enter tag (e.g., High Priority, Urgent)" 
                                       class="form-input" required>
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-success" onclick="dashboard.addPriorityTag('${formId}', ${isForSubPlan})">
                                    <i class="fas fa-plus"></i> Add Tag
                                </button>
                                <button class="btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        `;
                        break;
                        
                    case 'link':
                        form.innerHTML = `
                            <div class="form-header">
                                <h4><i class="fas fa-link"></i> Add Link</h4>
                                <button class="form-close-btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="form-group">
                                <input type="text" id="linkTitle${formSuffix}" placeholder="Link Title *" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <input type="url" id="linkUrl${formSuffix}" placeholder="URL/Link *" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <select id="linkType${formSuffix}" class="form-input">
                                    <option value="video">Video</option>
                                    <option value="article">Article</option>
                                    <option value="documentation">Documentation</option>
                                    <option value="resource">Resource</option>
                                    <option value="website">Website</option>
                                    <option value="tool">Tool</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <textarea id="linkDescription${formSuffix}" placeholder="Description (Optional)" 
                                          class="form-input" rows="3"></textarea>
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-success" onclick="dashboard.addLink('${formId}', ${isForSubPlan})">
                                    <i class="fas fa-plus"></i> Add Link
                                </button>
                                <button class="btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        `;
                        break;
                        
                    case 'kanban':
                        form.innerHTML = `
                            <div class="form-header">
                                <h4><i class="fas fa-columns"></i> Add Kanban Board</h4>
                                <button class="form-close-btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="form-group">
                                <input type="text" id="kanbanTitle${formSuffix}" placeholder="Board Title" class="form-input" value="Project Tasks">
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Columns</label>
                                <div id="kanbanColumns${formSuffix}" style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input type="text" class="form-input" value="To Do" placeholder="Column name">
                                        <input type="number" class="form-input" placeholder="Limit" style="width: 80px;">
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input type="text" class="form-input" value="In Progress" placeholder="Column name">
                                        <input type="number" class="form-input" placeholder="Limit" style="width: 80px;">
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input type="text" class="form-input" value="Done" placeholder="Column name">
                                        <input type="number" class="form-input" placeholder="Limit" style="width: 80px;">
                                    </div>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-success" onclick="dashboard.addKanbanBoard('${formId}', ${isForSubPlan})">
                                    <i class="fas fa-plus"></i> Add Board
                                </button>
                                <button class="btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        `;
                        break;
                        
                    case 'swot':
                        form.innerHTML = `
                            <div class="form-header">
                                <h4><i class="fas fa-th-large"></i> Add SWOT Analysis</h4>
                                <button class="form-close-btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Strengths (one per line)</label>
                                <textarea id="swotStrengths${formSuffix}" class="form-input" rows="2" placeholder="Our advantages..."></textarea>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Weaknesses (one per line)</label>
                                <textarea id="swotWeaknesses${formSuffix}" class="form-input" rows="2" placeholder="Areas to improve..."></textarea>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Opportunities (one per line)</label>
                                <textarea id="swotOpportunities${formSuffix}" class="form-input" rows="2" placeholder="Potential opportunities..."></textarea>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Threats (one per line)</label>
                                <textarea id="swotThreats${formSuffix}" class="form-input" rows="2" placeholder="Potential threats..."></textarea>
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-success" onclick="dashboard.addSwotAnalysis('${formId}', ${isForSubPlan})">
                                    <i class="fas fa-plus"></i> Add SWOT
                                </button>
                                <button class="btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        `;
                        break;
                        
                    case 'progress':
                        const todayDate = new Date().toISOString().split('T')[0];
                        const nextMonthDate = new Date(Date.now() + 30 * 86400000).toISOString().split('T')[0];
                        
                        form.innerHTML = `
                            <div class="form-header">
                                <h4><i class="fas fa-chart-line"></i> Add Progress Tracker</h4>
                                <button class="form-close-btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Progress Title *</label>
                                <input type="text" id="progressTitle${formSuffix}" class="form-input" placeholder="e.g., Project Completion, Sales Target" value="Progress Tracker" required>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Current Value</label>
                                    <input type="number" id="progressCurrent${formSuffix}" class="form-input" value="0" min="0">
                                </div>
                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Target Value</label>
                                    <input type="number" id="progressTarget${formSuffix}" class="form-input" value="100" min="1">
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Unit</label>
                                    <input type="text" id="progressUnit${formSuffix}" class="form-input" placeholder="e.g., %, points, units">
                                </div>
                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Status</label>
                                    <select id="progressStatus${formSuffix}" class="form-input">
                                        <option value="on-track">On Track</option>
                                        <option value="delayed">Delayed</option>
                                        <option value="ahead">Ahead of Schedule</option>
                                        <option value="completed">Completed</option>
                                        <option value="not-started">Not Started</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Start Date</label>
                                    <input type="date" id="progressStartDate${formSuffix}" class="form-input" value="${todayDate}">
                                </div>
                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">End Date</label>
                                    <input type="date" id="progressEndDate${formSuffix}" class="form-input" value="${nextMonthDate}">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">
                                    Milestones (one per line, format: Label:Value)
                                </label>
                                <textarea id="progressMilestones${formSuffix}" class="form-input" rows="3" placeholder="e.g., Phase 1:25&#10;Phase 2:50&#10;Phase 3:75"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Notes</label>
                                <textarea id="progressNotes${formSuffix}" class="form-input" rows="2" placeholder="Additional notes..."></textarea>
                            </div>
                            
                            <div class="form-actions">
                                <button class="btn btn-success" onclick="dashboard.addProgressTracker('${formId}', ${isForSubPlan})">
                                    <i class="fas fa-plus"></i> Add Tracker
                                </button>
                                <button class="btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        `;
                        break;
                }
                
                return form;
            }

            getEditForm(contentItem, isForSubPlan = false) {
                const form = document.createElement('div');
                form.className = 'content-form edit-form';
                
                const formId = `edit-form-${Date.now()}`;
                form.id = formId;
                
                const formSuffix = isForSubPlan ? 'SubPlan' : '';
                
                switch(contentItem.type) {
                    case 'model':
                        const modelPlan = this.allPlansData[contentItem.id];
                        
                        form.innerHTML = `
                            <div class="form-header">
                                <h4><i class="fas fa-cube"></i> Edit Model</h4>
                                <button class="form-close-btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="form-group">
                                <input type="text" id="editModelTitle${formSuffix}" placeholder="Model Title *" class="form-input" value="${contentItem.data.title || ''}" required>
                            </div>
                            <div class="form-group">
                                <textarea id="editModelDescription${formSuffix}" placeholder="Model Description (Optional)" 
                                          class="form-input" rows="3">${contentItem.data.description || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Model Photo</label>
                                <div id="editModelPhotoPreview${formSuffix}" style="width: 80px; height: 80px; border-radius: var(--radius); overflow: hidden; margin-bottom: 1rem; border: 2px solid var(--gray-300);">
                                    ${modelPlan?.photo ? `
                                        <img src="${modelPlan.photo}" alt="Model Photo" style="width: 100%; height: 100%; object-fit: cover;">
                                    ` : `
                                        <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: var(--gray-100); color: var(--gray-500);">
                                            <i class="fas fa-camera"></i>
                                        </div>
                                    `}
                                </div>
                                <input type="file" id="editModelPhotoInput${formSuffix}" accept="image/*" style="display: none;">
                                <button class="btn" id="editUploadModelPhotoBtn${formSuffix}" style="width: 100%;">
                                    <i class="fas fa-upload"></i> Change Photo
                                </button>
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-success" onclick="dashboard.updateModel('${formId}', '${contentItem.id}', ${isForSubPlan})">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                                <button class="btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        `;
                        
                        // Add photo upload functionality
                        setTimeout(() => {
                            const photoInput = document.getElementById(`editModelPhotoInput${formSuffix}`);
                            const uploadBtn = document.getElementById(`editUploadModelPhotoBtn${formSuffix}`);
                            const preview = document.getElementById(`editModelPhotoPreview${formSuffix}`);
                            
                            uploadBtn.addEventListener('click', () => {
                                photoInput.click();
                            });
                            
                            photoInput.addEventListener('change', (e) => {
                                const file = e.target.files[0];
                                if (file) {
                                    const reader = new FileReader();
                                    reader.onload = (event) => {
                                        preview.innerHTML = `<img src="${event.target.result}" alt="Model Photo" style="width: 100%; height: 100%; object-fit: cover;">`;
                                    };
                                    reader.readAsDataURL(file);
                                }
                            });
                        }, 100);
                        break;
                        
                    case 'description':
                        form.innerHTML = `
                            <div class="form-header">
                                <h4><i class="fas fa-sticky-note"></i> Edit Description</h4>
                                <button class="form-close-btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="form-group">
                                <textarea id="editDescriptionText${formSuffix}" placeholder="Enter description..." 
                                          class="form-input" rows="5" required>${contentItem.data.text || ''}</textarea>
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-success" onclick="dashboard.updateContent('${formId}', '${contentItem.id}', ${isForSubPlan})">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                                <button class="btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        `;
                        break;
                        
                    case 'checkbox':
                        // Ensure tasks array exists
                        if (!contentItem.data.tasks) {
                            contentItem.data.tasks = [];
                        }
                        
                        form.innerHTML = `
                            <div class="form-header">
                                <h4><i class="fas fa-tasks"></i> Edit Checklist</h4>
                                <button class="form-close-btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div id="editChecklistTasks${formSuffix}" style="margin-bottom: 1rem;">
                                ${contentItem.data.tasks.map((task, index) => `
                                    <div class="form-group" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;">
                                        <input type="checkbox" ${task.completed ? 'checked' : ''} 
                                               onchange="dashboard.updateTaskCompletion('${contentItem.id}', ${index}, this.checked, ${isForSubPlan})"
                                               style="margin-top: 0;">
                                        <input type="text" class="form-input" value="${task.text || ''}" 
                                               id="editTaskText${formSuffix}_${index}" placeholder="Task description">
                                        <button class="btn btn-danger" onclick="dashboard.removeTask('${formId}', '${contentItem.id}', ${index}, ${isForSubPlan})" style="padding: 0.5rem;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                `).join('')}
                                ${contentItem.data.tasks.length === 0 ? '<p style="color: var(--gray-500); font-style: italic; text-align: center;">No tasks yet</p>' : ''}
                            </div>
                            <div class="form-group">
                                <input type="text" id="newTaskText${formSuffix}" placeholder="Add new task" class="form-input">
                                <button class="btn" onclick="dashboard.addNewTask('${formId}', '${contentItem.id}', ${isForSubPlan})" style="margin-top: 0.5rem; width: 100%;">
                                    <i class="fas fa-plus"></i> Add Task
                                </button>
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-success" onclick="dashboard.updateChecklist('${formId}', '${contentItem.id}', ${isForSubPlan})">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                                <button class="btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        `;
                        break;
                        
                    case 'timeline':
                        form.innerHTML = `
                            <div class="form-header">
                                <h4><i class="fas fa-calendar-alt"></i> Edit Timeline</h4>
                                <button class="form-close-btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Start Date</label>
                                    <input type="date" id="editTimelineStart${formSuffix}" class="form-input" value="${contentItem.data.startDate || ''}">
                                </div>
                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">End Date</label>
                                    <input type="date" id="editTimelineEnd${formSuffix}" class="form-input" value="${contentItem.data.endDate || ''}">
                                </div>
                            </div>
                            <div class="form-group">
                                <textarea id="editTimelineDesc${formSuffix}" placeholder="Timeline description" 
                                          class="form-input" rows="3">${contentItem.data.description || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <select id="editTimelineStatus${formSuffix}" class="form-input">
                                    <option value="planned" ${contentItem.data.status === 'planned' ? 'selected' : ''}>Planned</option>
                                    <option value="in-progress" ${contentItem.data.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                    <option value="completed" ${contentItem.data.status === 'completed' ? 'selected' : ''}>Completed</option>
                                    <option value="on-hold" ${contentItem.data.status === 'on-hold' ? 'selected' : ''}>On Hold</option>
                                </select>
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-success" onclick="dashboard.updateContent('${formId}', '${contentItem.id}', ${isForSubPlan})">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                                <button class="btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        `;
                        break;
                        
                    case 'priority':
                        form.innerHTML = `
                            <div class="form-header">
                                <h4><i class="fas fa-flag"></i> Edit Priority Tags</h4>
                                <button class="form-close-btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div id="editTagsContainer${formSuffix}" style="margin-bottom: 1rem;">
                                ${contentItem.data.tags && contentItem.data.tags.length > 0 ? contentItem.data.tags.map((tag, index) => `
                                    <div class="form-group" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <input type="text" class="form-input" value="${tag}" 
                                               id="editTagText${formSuffix}_${index}" placeholder="Tag text">
                                        <button class="btn btn-danger" onclick="dashboard.removeTag('${formId}', '${contentItem.id}', ${index}, ${isForSubPlan})" style="padding: 0.5rem;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                `).join('') : '<p style="color: var(--gray-500); font-style: italic; text-align: center;">No tags yet</p>'}
                            </div>
                            <div class="form-group">
                                <input type="text" id="newTagText${formSuffix}" placeholder="Add new tag" class="form-input">
                                <button class="btn" onclick="dashboard.addNewTag('${formId}', '${contentItem.id}', ${isForSubPlan})" style="margin-top: 0.5rem; width: 100%;">
                                    <i class="fas fa-plus"></i> Add Tag
                                </button>
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-success" onclick="dashboard.updatePriorityTags('${formId}', '${contentItem.id}', ${isForSubPlan})">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                                <button class="btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        `;
                        break;
                        
                    case 'link':
                        // Ensure links array exists
                        if (!contentItem.data.links) {
                            contentItem.data.links = [];
                        }
                        
                        form.innerHTML = `
                            <div class="form-header">
                                <h4><i class="fas fa-link"></i> Edit Link</h4>
                                <button class="form-close-btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            ${contentItem.data.links.length > 0 ? contentItem.data.links.map((link, index) => `
                                <div style="background: var(--gray-100); padding: 1rem; border-radius: var(--radius); margin-bottom: 1rem;">
                                    <div class="form-group">
                                        <input type="text" id="editLinkTitle${formSuffix}_${index}" placeholder="Link Title *" 
                                               class="form-input" value="${link.title || ''}" required>
                                    </div>
                                    <div class="form-group">
                                        <input type="url" id="editLinkUrl${formSuffix}_${index}" placeholder="URL/Link *" 
                                               class="form-input" value="${link.url || ''}" required>
                                    </div>
                                    <div class="form-group">
                                        <select id="editLinkType${formSuffix}_${index}" class="form-input">
                                            <option value="video" ${link.type === 'video' ? 'selected' : ''}>Video</option>
                                            <option value="article" ${link.type === 'article' ? 'selected' : ''}>Article</option>
                                            <option value="documentation" ${link.type === 'documentation' ? 'selected' : ''}>Documentation</option>
                                            <option value="resource" ${link.type === 'resource' ? 'selected' : ''}>Resource</option>
                                            <option value="website" ${link.type === 'website' ? 'selected' : ''}>Website</option>
                                            <option value="tool" ${link.type === 'tool' ? 'selected' : ''}>Tool</option>
                                            <option value="other" ${link.type === 'other' ? 'selected' : ''}>Other</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <textarea id="editLinkDescription${formSuffix}_${index}" placeholder="Description (Optional)" 
                                                  class="form-input" rows="2">${link.description || ''}</textarea>
                                    </div>
                                </div>
                            `).join('') : '<p style="color: var(--gray-500); font-style: italic; text-align: center;">No links yet</p>'}
                            <div class="form-actions">
                                <button class="btn btn-success" onclick="dashboard.updateLinks('${formId}', '${contentItem.id}', ${isForSubPlan})">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                                <button class="btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        `;
                        break;
                        
                    case 'kanban':
                        form.innerHTML = `
                            <div class="form-header">
                                <h4><i class="fas fa-columns"></i> Edit Kanban Board</h4>
                                <button class="form-close-btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div id="editKanbanColumns${formSuffix}" style="margin-bottom: 1rem;">
                                ${contentItem.data.columns.map((column, colIndex) => `
                                    <div style="background: var(--gray-100); padding: 1rem; border-radius: var(--radius); margin-bottom: 1rem;">
                                        <div class="form-group">
                                            <input type="text" id="editColumnName${formSuffix}_${colIndex}" placeholder="Column Name" 
                                                   class="form-input" value="${column.name || ''}" required>
                                        </div>
                                        <div class="form-group">
                                            <input type="number" id="editColumnLimit${formSuffix}_${colIndex}" placeholder="Task Limit (empty for unlimited)" 
                                                   class="form-input" value="${column.limit || ''}">
                                        </div>
                                        <div style="margin-top: 1rem;">
                                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Tasks</label>
                                            <div id="editColumnTasks${formSuffix}_${colIndex}">
                                                ${column.tasks.map((task, taskIndex) => `
                                                    <div class="form-group" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                                        <input type="text" class="form-input" value="${task}" 
                                                               id="editTask${formSuffix}_${colIndex}_${taskIndex}" placeholder="Task">
                                                        <button class="btn btn-danger" onclick="dashboard.removeKanbanTask('${formId}', '${contentItem.id}', ${colIndex}, ${taskIndex}, ${isForSubPlan})" style="padding: 0.5rem;">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                `).join('')}
                                            </div>
                                            <button class="btn" onclick="dashboard.addNewKanbanTask('${formId}', '${contentItem.id}', ${colIndex}, ${isForSubPlan})" style="margin-top: 0.5rem; width: 100%;">
                                                <i class="fas fa-plus"></i> Add Task
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-success" onclick="dashboard.updateKanbanBoard('${formId}', '${contentItem.id}', ${isForSubPlan})">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                                <button class="btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        `;
                        break;
                        
                    case 'swot':
                        form.innerHTML = `
                            <div class="form-header">
                                <h4><i class="fas fa-th-large"></i> Edit SWOT Analysis</h4>
                                <button class="form-close-btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Strengths (one per line)</label>
                                <textarea id="editSwotStrengths${formSuffix}" class="form-input" rows="3">${(contentItem.data.strengths || []).join('\n')}</textarea>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Weaknesses (one per line)</label>
                                <textarea id="editSwotWeaknesses${formSuffix}" class="form-input" rows="3">${(contentItem.data.weaknesses || []).join('\n')}</textarea>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Opportunities (one per line)</label>
                                <textarea id="editSwotOpportunities${formSuffix}" class="form-input" rows="3">${(contentItem.data.opportunities || []).join('\n')}</textarea>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Threats (one per line)</label>
                                <textarea id="editSwotThreats${formSuffix}" class="form-input" rows="3">${(contentItem.data.threats || []).join('\n')}</textarea>
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-success" onclick="dashboard.updateSwotAnalysis('${formId}', '${contentItem.id}', ${isForSubPlan})">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                                <button class="btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        `;
                        break;
                        
                    case 'progress':
                        const milestonesText = contentItem.data.milestones ? 
                            contentItem.data.milestones.map(m => `${m.label}:${m.value}`).join('\n') : '';
                        
                        form.innerHTML = `
                            <div class="form-header">
                                <h4><i class="fas fa-chart-line"></i> Edit Progress Tracker</h4>
                                <button class="form-close-btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Progress Title *</label>
                                <input type="text" id="editProgressTitle${formSuffix}" class="form-input" value="${contentItem.data.title || 'Progress Tracker'}" required>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Current Value</label>
                                    <input type="number" id="editProgressCurrent${formSuffix}" class="form-input" value="${contentItem.data.current || 0}" min="0">
                                </div>
                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Target Value</label>
                                    <input type="number" id="editProgressTarget${formSuffix}" class="form-input" value="${contentItem.data.target || 100}" min="1">
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Unit</label>
                                    <input type="text" id="editProgressUnit${formSuffix}" class="form-input" value="${contentItem.data.unit || ''}" placeholder="e.g., %, points, units">
                                </div>
                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Status</label>
                                    <select id="editProgressStatus${formSuffix}" class="form-input">
                                        <option value="on-track" ${contentItem.data.status === 'on-track' ? 'selected' : ''}>On Track</option>
                                        <option value="delayed" ${contentItem.data.status === 'delayed' ? 'selected' : ''}>Delayed</option>
                                        <option value="ahead" ${contentItem.data.status === 'ahead' ? 'selected' : ''}>Ahead of Schedule</option>
                                        <option value="completed" ${contentItem.data.status === 'completed' ? 'selected' : ''}>Completed</option>
                                        <option value="not-started" ${contentItem.data.status === 'not-started' ? 'selected' : ''}>Not Started</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Start Date</label>
                                    <input type="date" id="editProgressStartDate${formSuffix}" class="form-input" value="${contentItem.data.startDate || ''}">
                                </div>
                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">End Date</label>
                                    <input type="date" id="editProgressEndDate${formSuffix}" class="form-input" value="${contentItem.data.endDate || ''}">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">
                                    Milestones (one per line, format: Label:Value)
                                </label>
                                <textarea id="editProgressMilestones${formSuffix}" class="form-input" rows="3" placeholder="e.g., Phase 1:25&#10;Phase 2:50&#10;Phase 3:75">${milestonesText}</textarea>
                            </div>
                            
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Notes</label>
                                <textarea id="editProgressNotes${formSuffix}" class="form-input" rows="2" placeholder="Additional notes...">${contentItem.data.notes || ''}</textarea>
                            </div>
                            
                            <div class="form-actions">
                                <button class="btn btn-success" onclick="dashboard.updateProgressTracker('${formId}', '${contentItem.id}', ${isForSubPlan})">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                                <button class="btn" onclick="dashboard.hideContentForm('${formId}')">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        `;
                        break;
                }
                
                return form;
            }

            hideContentForm(formId) {
                const form = document.getElementById(formId);
                if (form) {
                    form.remove();
                }
            }

            async addDescription(formId, isForSubPlan = false) {
                const suffix = isForSubPlan ? 'SubPlan' : '';
                const text = document.getElementById(`descriptionText${suffix}`).value;
                if (text.trim()) {
                    const newDesc = {
                        id: Date.now().toString(),
                        type: 'description',
                        data: { text },
                        created_at: new Date().toISOString()
                    };
                    
                    let parentPlan;
                    if (isForSubPlan) {
                        parentPlan = this.currentSubPlan;
                    } else {
                        parentPlan = this.currentPlan;
                    }
                    
                    try {
                        const response = await fetch(`${this.apiBaseUrl}/api/plans/${parentPlan.id}/content`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(newDesc)
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            if (!parentPlan.content) {
                                parentPlan.content = [];
                            }
                            parentPlan.content.push(result.data);
                            
                            if (isForSubPlan) {
                                this.renderSubPlanModalContent(parentPlan);
                            } else {
                                this.renderModalContent(parentPlan);
                            }
                            
                            this.hideContentForm(formId);
                            this.showNotification('Description added! 📝', 'success');
                        }
                    } catch (error) {
                        console.error('Error adding description:', error);
                        this.showNotification('Failed to add description', 'error');
                    }
                } else {
                    this.showNotification('Please enter description', 'warning');
                }
            }

            // Modified to use API
            async addChecklistItem(formId, isForSubPlan = false) {
                const suffix = isForSubPlan ? 'SubPlan' : '';
                const text = document.getElementById(`taskText${suffix}`).value;
                
                if (text.trim()) {
                    let parentPlan;
                    if (isForSubPlan) {
                        parentPlan = this.currentSubPlan;
                    } else {
                        parentPlan = this.currentPlan;
                    }
                    
                    // Check if checklist already exists
                    let checklist = parentPlan.content.find(item => item.type === 'checkbox');
                    
                    if (checklist) {
                        // Update existing checklist
                        if (!checklist.data.tasks) checklist.data.tasks = [];
                        checklist.data.tasks.push({ 
                            text: text.trim(), 
                            completed: false 
                        });
                        
                        try {
                            const response = await fetch(`${this.apiBaseUrl}/api/plans/${parentPlan.id}/content/${checklist.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(checklist)
                            });
                            
                            const result = await response.json();
                            if (result.success) {
                                if (isForSubPlan) {
                                    this.renderSubPlanModalContent(parentPlan);
                                } else {
                                    this.renderModalContent(parentPlan);
                                }
                                this.hideContentForm(formId);
                                this.showNotification('Task added to checklist! ✅', 'success');
                            }
                        } catch (error) {
                            console.error('Error updating checklist:', error);
                            this.showNotification('Failed to update checklist', 'error');
                        }
                    } else {
                        // Create new checklist
                        const newChecklist = {
                            id: Date.now().toString(),
                            type: 'checkbox',
                            data: { 
                                tasks: [{ 
                                    text: text.trim(), 
                                    completed: false 
                                }] 
                            },
                            created_at: new Date().toISOString()
                        };
                        
                        try {
                            const response = await fetch(`${this.apiBaseUrl}/api/plans/${parentPlan.id}/content`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(newChecklist)
                            });
                            
                            const result = await response.json();
                            if (result.success) {
                                if (!parentPlan.content) parentPlan.content = [];
                                parentPlan.content.push(result.data);
                                
                                if (isForSubPlan) {
                                    this.renderSubPlanModalContent(parentPlan);
                                } else {
                                    this.renderModalContent(parentPlan);
                                }
                                this.hideContentForm(formId);
                                this.showNotification('Task added to checklist! ✅', 'success');
                            }
                        } catch (error) {
                            console.error('Error adding checklist:', error);
                            this.showNotification('Failed to add checklist', 'error');
                        }
                    }
                } else {
                    this.showNotification('Please enter task description', 'warning');
                }
            }

            addTimeline(formId, isForSubPlan = false) {
                const suffix = isForSubPlan ? 'SubPlan' : '';
                const startDate = document.getElementById(`timelineStart${suffix}`).value;
                const endDate = document.getElementById(`timelineEnd${suffix}`).value;
                const description = document.getElementById(`timelineDesc${suffix}`).value;
                const status = document.getElementById(`timelineStatus${suffix}`).value;
                
                if (startDate || endDate || description.trim()) {
                    const timeline = {
                        id: Date.now(),
                        type: 'timeline',
                        data: { startDate, endDate, description, status },
                        created_at: new Date().toISOString()
                    };
                    
                    let parentPlan;
                    if (isForSubPlan) {
                        parentPlan = this.currentSubPlan;
                    } else {
                        parentPlan = this.currentPlan;
                    }
                    
                    if (!parentPlan.content) {
                        parentPlan.content = [];
                    }
                    parentPlan.content.push(timeline);
                    
                    if (isForSubPlan) {
                        this.renderSubPlanModalContent(parentPlan);
                    } else {
                        this.renderModalContent(parentPlan);
                    }
                    
                    this.hideContentForm(formId);
                    
                    this.showNotification('Timeline added! 📅', 'success');
                } else {
                    this.showNotification('Please fill at least one field', 'warning');
                }
            }

            addPriorityTag(formId, isForSubPlan = false) {
                const suffix = isForSubPlan ? 'SubPlan' : '';
                const tag = document.getElementById(`tagText${suffix}`).value;
                if (tag.trim()) {
                    let parentPlan;
                    if (isForSubPlan) {
                        parentPlan = this.currentSubPlan;
                    } else {
                        parentPlan = this.currentPlan;
                    }
                    
                    if (!parentPlan.content) {
                        parentPlan.content = [];
                    }
                    
                    let priorityItem = parentPlan.content.find(item => item.type === 'priority');
                    
                    if (priorityItem) {
                        if (!priorityItem.data.tags) priorityItem.data.tags = [];
                        priorityItem.data.tags.push(tag);
                    } else {
                        priorityItem = {
                            id: Date.now(),
                            type: 'priority',
                            data: { tags: [tag] },
                            created_at: new Date().toISOString()
                        };
                        parentPlan.content.push(priorityItem);
                    }
                    
                    if (isForSubPlan) {
                        this.renderSubPlanModalContent(parentPlan);
                    } else {
                        this.renderModalContent(parentPlan);
                    }
                    
                    this.hideContentForm(formId);
                    
                    this.showNotification('Tag added! 🏷️', 'success');
                } else {
                    this.showNotification('Please enter tag', 'warning');
                }
            }

            addLink(formId, isForSubPlan = false) {
                const suffix = isForSubPlan ? 'SubPlan' : '';
                const title = document.getElementById(`linkTitle${suffix}`).value;
                const url = document.getElementById(`linkUrl${suffix}`).value;
                const type = document.getElementById(`linkType${suffix}`).value;
                const description = document.getElementById(`linkDescription${suffix}`).value;
                
                if (!title.trim() || !url.trim()) {
                    this.showNotification('Please enter link title and URL', 'warning');
                    return;
                }
                
                // Validate URL
                let validUrl = url;
                if (!validUrl.startsWith('http://') && !validUrl.startsWith('https://')) {
                    validUrl = 'https://' + validUrl;
                }
                
                let parentPlan;
                if (isForSubPlan) {
                    parentPlan = this.currentSubPlan;
                } else {
                    parentPlan = this.currentPlan;
                }
                
                if (!parentPlan.content) {
                    parentPlan.content = [];
                }
                
                // Check if link item already exists
                let linkItem = parentPlan.content.find(item => item.type === 'link');
                
                if (linkItem) {
                    if (!linkItem.data.links) linkItem.data.links = [];
                    linkItem.data.links.push({
                        title: title.trim(),
                        url: validUrl,
                        type: type,
                        description: description.trim(),
                        added_at: new Date().toISOString()
                    });
                } else {
                    linkItem = {
                        id: Date.now(),
                        type: 'link',
                        data: {
                            links: [{
                                title: title.trim(),
                                url: validUrl,
                                type: type,
                                description: description.trim(),
                                added_at: new Date().toISOString()
                            }]
                        },
                        created_at: new Date().toISOString()
                    };
                    parentPlan.content.push(linkItem);
                }
                
                if (isForSubPlan) {
                    this.renderSubPlanModalContent(parentPlan);
                } else {
                    this.renderModalContent(parentPlan);
                }
                
                this.hideContentForm(formId);
                
                this.showNotification('Link added successfully! 🔗', 'success');
            }

            addKanbanBoard(formId, isForSubPlan = false) {
                const suffix = isForSubPlan ? 'SubPlan' : '';
                const title = document.getElementById(`kanbanTitle${suffix}`).value || 'Project Tasks';
                const columns = Array.from(document.querySelectorAll(`#kanbanColumns${suffix} > div`)).map(div => {
                    const inputs = div.querySelectorAll('input');
                    return {
                        name: inputs[0].value || 'Column',
                        tasks: [],
                        limit: inputs[1].value ? parseInt(inputs[1].value) : null
                    };
                });
                
                const kanban = {
                    id: Date.now(),
                    type: 'kanban',
                    data: { columns },
                    created_at: new Date().toISOString()
                };
                
                let parentPlan;
                if (isForSubPlan) {
                    parentPlan = this.currentSubPlan;
                } else {
                    parentPlan = this.currentPlan;
                }
                
                if (!parentPlan.content) {
                    parentPlan.content = [];
                }
                parentPlan.content.push(kanban);
                
                if (isForSubPlan) {
                    this.renderSubPlanModalContent(parentPlan);
                } else {
                    this.renderModalContent(parentPlan);
                }
                
                this.hideContentForm(formId);
                
                this.showNotification('Kanban board created! 📋', 'success');
            }

            addKanbanTask(contentId, columnIndex, isForSubPlan = false) {
                const task = prompt('Enter task description:');
                if (task && task.trim()) {
                    let contentArray;
                    if (isForSubPlan) {
                        contentArray = this.currentSubPlan.content;
                    } else {
                        contentArray = this.currentPlan.content;
                    }
                    
                    const kanban = contentArray.find(item => item.id === contentId);
                    
                    if (kanban && kanban.data.columns[columnIndex]) {
                        kanban.data.columns[columnIndex].tasks.push(task);
                        
                        if (isForSubPlan) {
                            this.renderSubPlanModalContent(this.currentSubPlan);
                        } else {
                            this.renderModalContent(this.currentPlan);
                        }
                        
                        this.showNotification('Task added to board! 📝', 'success');
                    }
                }
            }

            addSwotAnalysis(formId, isForSubPlan = false) {
                const suffix = isForSubPlan ? 'SubPlan' : '';
                const strengths = document.getElementById(`swotStrengths${suffix}`).value.split('\n').filter(s => s.trim());
                const weaknesses = document.getElementById(`swotWeaknesses${suffix}`).value.split('\n').filter(w => w.trim());
                const opportunities = document.getElementById(`swotOpportunities${suffix}`).value.split('\n').filter(o => o.trim());
                const threats = document.getElementById(`swotThreats${suffix}`).value.split('\n').filter(t => t.trim());
                
                const swot = {
                    id: Date.now(),
                    type: 'swot',
                    data: { strengths, weaknesses, opportunities, threats },
                    created_at: new Date().toISOString()
                };
                
                let parentPlan;
                if (isForSubPlan) {
                    parentPlan = this.currentSubPlan;
                } else {
                    parentPlan = this.currentPlan;
                }
                
                if (!parentPlan.content) {
                    parentPlan.content = [];
                }
                parentPlan.content.push(swot);
                
                if (isForSubPlan) {
                    this.renderSubPlanModalContent(parentPlan);
                } else {
                    this.renderModalContent(parentPlan);
                }
                
                this.hideContentForm(formId);
                
                this.showNotification('SWOT analysis added! 📊', 'success');
            }

            // NEW: Progress Tracker Method (Advanced Only)
            addProgressTracker(formId, isForSubPlan = false) {
                const suffix = isForSubPlan ? 'SubPlan' : '';
                const title = document.getElementById(`progressTitle${suffix}`).value || 'Progress Tracker';
                const current = parseFloat(document.getElementById(`progressCurrent${suffix}`).value) || 0;
                const target = parseFloat(document.getElementById(`progressTarget${suffix}`).value) || 100;
                const unit = document.getElementById(`progressUnit${suffix}`).value || '';
                const status = document.getElementById(`progressStatus${suffix}`).value || 'on-track';
                const startDate = document.getElementById(`progressStartDate${suffix}`).value;
                const endDate = document.getElementById(`progressEndDate${suffix}`).value;
                const notes = document.getElementById(`progressNotes${suffix}`).value || '';
                
                // Parse milestones
                const milestonesText = document.getElementById(`progressMilestones${suffix}`).value;
                const milestones = milestonesText.split('\n')
                    .filter(m => m.trim())
                    .map(m => {
                        const parts = m.split(':');
                        return {
                            label: parts[0]?.trim() || `Milestone ${Math.random().toString(36).substr(2, 5)}`,
                            value: parseFloat(parts[1]?.trim()) || 0,
                            completed: false
                        };
                    });
                
                if (target <= 0) {
                    this.showNotification('Target value must be greater than 0', 'warning');
                    return;
                }
                
                const tracker = {
                    id: Date.now(),
                    type: 'progress',
                    data: { 
                        title: title,
                        current: current, 
                        target: target, 
                        unit: unit,
                        status: status,
                        startDate: startDate,
                        endDate: endDate,
                        milestones: milestones,
                        notes: notes
                    },
                    created_at: new Date().toISOString()
                };
                
                let parentPlan;
                if (isForSubPlan) {
                    parentPlan = this.currentSubPlan;
                } else {
                    parentPlan = this.currentPlan;
                }
                
                if (!parentPlan.content) {
                    parentPlan.content = [];
                }
                parentPlan.content.push(tracker);
                
                this.hideContentForm(formId);
                
                if (isForSubPlan) {
                    this.renderSubPlanModalContent(parentPlan);
                } else {
                    this.renderModalContent(parentPlan);
                }
                
                this.showNotification('Progress tracker added! 🚀', 'success');
            }

            // Content Update Methods
            async updateModel(formId, contentId, isForSubPlan = false) {
                // Find the content item
                let contentArray, contentItem;
                
                if (isForSubPlan) {
                    contentArray = this.currentSubPlan.content;
                } else {
                    contentArray = this.currentPlan.content;
                }
                
                contentItem = contentArray.find(item => item.id === contentId);
                
                if (!contentItem) {
                    this.showNotification('Content not found', 'error');
                    return;
                }
                
                const suffix = isForSubPlan ? 'SubPlan' : '';
                const title = document.getElementById(`editModelTitle${suffix}`).value;
                const description = document.getElementById(`editModelDescription${suffix}`).value;
                
                if (!title.trim()) {
                    this.showNotification('Please enter a model title', 'warning');
                    return;
                }
                
                contentItem.data.title = title;
                contentItem.data.description = description;
                
                // Also update in allPlansData
                const modelPlan = this.allPlansData[contentId];
                if (modelPlan) {
                    modelPlan.title = title;
                    modelPlan.description = description;
                    
                    // Update photo if changed
                    const photoPreview = document.querySelector(`#editModelPhotoPreview${suffix} img`);
                    if (photoPreview) {
                        modelPlan.photo = photoPreview.src;
                    }
                }
                
                try {
                    // Update content
                    const response = await fetch(`${this.apiBaseUrl}/api/plans/${this.currentPlan.id}/content/${contentId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(contentItem)
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        // Also update the plan itself if it exists
                        if (modelPlan) {
                            await fetch(`${this.apiBaseUrl}/api/plans/${contentId}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ 
                                    title: title, 
                                    photo: modelPlan.photo,
                                    description: description
                                })
                            });
                        }
                        
                        this.hideContentForm(formId);
                        
                        if (isForSubPlan) {
                            this.renderSubPlanModalContent(this.currentSubPlan);
                        } else {
                            this.renderModalContent(this.currentPlan);
                        }
                        
                        this.showNotification('Model updated successfully! ✏️', 'success');
                    }
                } catch (error) {
                    console.error('Error updating model:', error);
                    this.showNotification('Failed to update model', 'error');
                }
            }

            async updateContent(formId, contentId, isForSubPlan = false) {
                // Find the content item
                let contentArray, contentItem;
                
                if (isForSubPlan) {
                    contentArray = this.currentSubPlan.content;
                } else {
                    contentArray = this.currentPlan.content;
                }
                
                contentItem = contentArray.find(item => item.id === contentId);
                
                if (!contentItem) {
                    this.showNotification('Content not found', 'error');
                    return;
                }
                
                const suffix = isForSubPlan ? 'SubPlan' : '';
                
                switch(contentItem.type) {
                    case 'description':
                        const text = document.getElementById(`editDescriptionText${suffix}`).value;
                        
                        if (!text.trim()) {
                            this.showNotification('Please enter description', 'warning');
                            return;
                        }
                        
                        contentItem.data.text = text;
                        break;
                        
                    case 'timeline':
                        const startDate = document.getElementById(`editTimelineStart${suffix}`).value;
                        const endDate = document.getElementById(`editTimelineEnd${suffix}`).value;
                        const timelineDesc = document.getElementById(`editTimelineDesc${suffix}`).value;
                        const timelineStatus = document.getElementById(`editTimelineStatus${suffix}`).value;
                        
                        contentItem.data.startDate = startDate;
                        contentItem.data.endDate = endDate;
                        contentItem.data.description = timelineDesc;
                        contentItem.data.status = timelineStatus;
                        break;
                }
                
                try {
                    const response = await fetch(`${this.apiBaseUrl}/api/plans/${this.currentPlan.id}/content/${contentId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(contentItem)
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        this.hideContentForm(formId);
                        
                        if (isForSubPlan) {
                            this.renderSubPlanModalContent(this.currentSubPlan);
                        } else {
                            this.renderModalContent(this.currentPlan);
                        }
                        
                        this.showNotification('Content updated successfully! ✏️', 'success');
                    }
                } catch (error) {
                    console.error('Error updating content:', error);
                    this.showNotification('Failed to update content', 'error');
                }
            }

            async updateChecklist(formId, contentId, isForSubPlan = false) {
                let contentArray, contentItem;
                
                if (isForSubPlan) {
                    contentArray = this.currentSubPlan.content;
                } else {
                    contentArray = this.currentPlan.content;
                }
                
                contentItem = contentArray.find(item => item.id === contentId);
                
                if (!contentItem || contentItem.type !== 'checkbox') {
                    this.showNotification('Checklist not found', 'error');
                    return;
                }
                
                // Ensure tasks array exists
                if (!contentItem.data.tasks) {
                    contentItem.data.tasks = [];
                }
                
                // Update task texts from inputs
                const suffix = isForSubPlan ? 'SubPlan' : '';
                const taskInputs = document.querySelectorAll(`[id^="editTaskText${suffix}_"]`);
                
                taskInputs.forEach((input, index) => {
                    if (contentItem.data.tasks[index]) {
                        contentItem.data.tasks[index].text = input.value;
                    }
                });
                
                try {
                    const response = await fetch(`${this.apiBaseUrl}/api/plans/${this.currentPlan.id}/content/${contentId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(contentItem)
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        this.hideContentForm(formId);
                        
                        if (isForSubPlan) {
                            this.renderSubPlanModalContent(this.currentSubPlan);
                        } else {
                            this.renderModalContent(this.currentPlan);
                        }
                        
                        this.showNotification('Checklist updated! ✅', 'success');
                    }
                } catch (error) {
                    console.error('Error updating checklist:', error);
                    this.showNotification('Failed to update checklist', 'error');
                }
            }

            async updateTaskCompletion(contentId, taskIndex, completed, isForSubPlan = false) {
                let contentArray;
                if (isForSubPlan) {
                    contentArray = this.currentSubPlan.content;
                } else {
                    contentArray = this.currentPlan.content;
                }
                
                const contentItem = contentArray.find(item => item.id === contentId);
                
                if (contentItem && contentItem.data.tasks && contentItem.data.tasks[taskIndex]) {
                    contentItem.data.tasks[taskIndex].completed = completed;
                    
                    try {
                        const planId = isForSubPlan ? this.currentSubPlan.id : this.currentPlan.id;
                        await fetch(`${this.apiBaseUrl}/api/plans/${planId}/checklist/${contentId}/task/${taskIndex}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ completed })
                        });
                        
                        // Award XP for completing tasks
                        if (completed) {
                            this.userData.xp += 10;
                            this.showNotification('+10 XP for completing task! ⚡', 'info');
                        }
                        
                        // Re-render
                        if (isForSubPlan) {
                            this.renderSubPlanModalContent(this.currentSubPlan);
                        } else {
                            this.renderModalContent(this.currentPlan);
                        }
                    } catch (error) {
                        console.error('Error updating task:', error);
                    }
                }
            }

            removeTask(formId, contentId, taskIndex, isForSubPlan = false) {
                let contentArray;
                if (isForSubPlan) {
                    contentArray = this.currentSubPlan.content;
                } else {
                    contentArray = this.currentPlan.content;
                }
                
                const contentItem = contentArray.find(item => item.id === contentId);
                
                if (contentItem && contentItem.data.tasks && contentItem.data.tasks[taskIndex]) {
                    contentItem.data.tasks.splice(taskIndex, 1);
                    
                    // Re-render the edit form
                    this.hideContentForm(formId);
                    this.showEditForm(contentId, isForSubPlan);
                }
            }

            addNewTask(formId, contentId, isForSubPlan = false) {
                const suffix = isForSubPlan ? 'SubPlan' : '';
                const newTaskText = document.getElementById(`newTaskText${suffix}`).value;
                
                if (!newTaskText.trim()) {
                    this.showNotification('Please enter task text', 'warning');
                    return;
                }
                
                let contentArray;
                if (isForSubPlan) {
                    contentArray = this.currentSubPlan.content;
                } else {
                    contentArray = this.currentPlan.content;
                }
                
                const contentItem = contentArray.find(item => item.id === contentId);
                
                if (contentItem) {
                    if (!contentItem.data.tasks) {
                        contentItem.data.tasks = [];
                    }
                    contentItem.data.tasks.push({ text: newTaskText, completed: false });
                    
                    // Clear the input
                    document.getElementById(`newTaskText${suffix}`).value = '';
                    
                    // Re-render the edit form
                    this.hideContentForm(formId);
                    this.showEditForm(contentId, isForSubPlan);
                }
            }

            updatePriorityTags(formId, contentId, isForSubPlan = false) {
                let contentArray, contentItem;
                
                if (isForSubPlan) {
                    contentArray = this.currentSubPlan.content;
                } else {
                    contentArray = this.currentPlan.content;
                }
                
                contentItem = contentArray.find(item => item.id === contentId);
                
                if (!contentItem || contentItem.type !== 'priority') {
                    this.showNotification('Priority tags not found', 'error');
                    return;
                }
                
                const suffix = isForSubPlan ? 'SubPlan' : '';
                const tagInputs = document.querySelectorAll(`[id^="editTagText${suffix}_"]`);
                
                contentItem.data.tags = Array.from(tagInputs).map(input => input.value).filter(tag => tag.trim());
                
                this.hideContentForm(formId);
                
                if (isForSubPlan) {
                    this.renderSubPlanModalContent(this.currentSubPlan);
                } else {
                    this.renderModalContent(this.currentPlan);
                }
                
                this.showNotification('Tags updated! 🏷️', 'success');
            }

            removeTag(formId, contentId, tagIndex, isForSubPlan = false) {
                let contentArray;
                if (isForSubPlan) {
                    contentArray = this.currentSubPlan.content;
                } else {
                    contentArray = this.currentPlan.content;
                }
                
                const contentItem = contentArray.find(item => item.id === contentId);
                
                if (contentItem && contentItem.data.tags && contentItem.data.tags[tagIndex]) {
                    contentItem.data.tags.splice(tagIndex, 1);
                    
                    // Re-render the edit form
                    this.hideContentForm(formId);
                    this.showEditForm(contentId, isForSubPlan);
                }
            }

            addNewTag(formId, contentId, isForSubPlan = false) {
                const suffix = isForSubPlan ? 'SubPlan' : '';
                const newTagText = document.getElementById(`newTagText${suffix}`).value;
                
                if (!newTagText.trim()) {
                    this.showNotification('Please enter tag text', 'warning');
                    return;
                }
                
                let contentArray;
                if (isForSubPlan) {
                    contentArray = this.currentSubPlan.content;
                } else {
                    contentArray = this.currentPlan.content;
                }
                
                const contentItem = contentArray.find(item => item.id === contentId);
                
                if (contentItem) {
                    if (!contentItem.data.tags) {
                        contentItem.data.tags = [];
                    }
                    contentItem.data.tags.push(newTagText);
                    
                    // Clear the input
                    document.getElementById(`newTagText${suffix}`).value = '';
                    
                    // Re-render the edit form
                    this.hideContentForm(formId);
                    this.showEditForm(contentId, isForSubPlan);
                }
            }

            updateLinks(formId, contentId, isForSubPlan = false) {
                let contentArray, contentItem;
                
                if (isForSubPlan) {
                    contentArray = this.currentSubPlan.content;
                } else {
                    contentArray = this.currentPlan.content;
                }
                
                contentItem = contentArray.find(item => item.id === contentId);
                
                if (!contentItem || contentItem.type !== 'link') {
                    this.showNotification('Links not found', 'error');
                    return;
                }
                
                const suffix = isForSubPlan ? 'SubPlan' : '';
                
                // Update each link
                if (contentItem.data.links) {
                    contentItem.data.links.forEach((link, index) => {
                        link.title = document.getElementById(`editLinkTitle${suffix}_${index}`)?.value || '';
                        link.url = document.getElementById(`editLinkUrl${suffix}_${index}`)?.value || '';
                        link.type = document.getElementById(`editLinkType${suffix}_${index}`)?.value || 'website';
                        link.description = document.getElementById(`editLinkDescription${suffix}_${index}`)?.value || '';
                    });
                }
                
                this.hideContentForm(formId);
                
                if (isForSubPlan) {
                    this.renderSubPlanModalContent(this.currentSubPlan);
                } else {
                    this.renderModalContent(this.currentPlan);
                }
                
                this.showNotification('Links updated! 🔗', 'success');
            }

            updateKanbanBoard(formId, contentId, isForSubPlan = false) {
                let contentArray, contentItem;
                
                if (isForSubPlan) {
                    contentArray = this.currentSubPlan.content;
                } else {
                    contentArray = this.currentPlan.content;
                }
                
                contentItem = contentArray.find(item => item.id === contentId);
                
                if (!contentItem || contentItem.type !== 'kanban') {
                    this.showNotification('Kanban board not found', 'error');
                    return;
                }
                
                const suffix = isForSubPlan ? 'SubPlan' : '';
                
                // Update columns
                const columnInputs = document.querySelectorAll(`[id^="editColumnName${suffix}_"]`);
                contentItem.data.columns = Array.from(columnInputs).map((input, index) => {
                    const columnName = input.value;
                    const limitInput = document.getElementById(`editColumnLimit${suffix}_${index}`);
                    const limit = limitInput?.value ? parseInt(limitInput.value) : null;
                    
                    // Get tasks for this column
                    const taskInputs = document.querySelectorAll(`[id^="editTask${suffix}_${index}_"]`);
                    const tasks = Array.from(taskInputs).map(taskInput => taskInput.value).filter(task => task.trim());
                    
                    return {
                        name: columnName,
                        limit: limit,
                        tasks: tasks
                    };
                });
                
                this.hideContentForm(formId);
                
                if (isForSubPlan) {
                    this.renderSubPlanModalContent(this.currentSubPlan);
                } else {
                    this.renderModalContent(this.currentPlan);
                }
                
                this.showNotification('Kanban board updated! 📋', 'success');
            }

            removeKanbanTask(formId, contentId, columnIndex, taskIndex, isForSubPlan = false) {
                let contentArray;
                if (isForSubPlan) {
                    contentArray = this.currentSubPlan.content;
                } else {
                    contentArray = this.currentPlan.content;
                }
                
                const contentItem = contentArray.find(item => item.id === contentId);
                
                if (contentItem && contentItem.data.columns[columnIndex] && contentItem.data.columns[columnIndex].tasks[taskIndex]) {
                    contentItem.data.columns[columnIndex].tasks.splice(taskIndex, 1);
                    
                    // Re-render the edit form
                    this.hideContentForm(formId);
                    this.showEditForm(contentId, isForSubPlan);
                }
            }

            addNewKanbanTask(formId, contentId, columnIndex, isForSubPlan = false) {
                const task = prompt('Enter new task description:');
                if (task && task.trim()) {
                    let contentArray;
                    if (isForSubPlan) {
                        contentArray = this.currentSubPlan.content;
                    } else {
                        contentArray = this.currentPlan.content;
                    }
                    
                    const contentItem = contentArray.find(item => item.id === contentId);
                    
                    if (contentItem && contentItem.data.columns[columnIndex]) {
                        contentItem.data.columns[columnIndex].tasks.push(task);
                        
                        // Re-render the edit form
                        this.hideContentForm(formId);
                        this.showEditForm(contentId, isForSubPlan);
                    }
                }
            }

            updateSwotAnalysis(formId, contentId, isForSubPlan = false) {
                let contentArray, contentItem;
                
                if (isForSubPlan) {
                    contentArray = this.currentSubPlan.content;
                } else {
                    contentArray = this.currentPlan.content;
                }
                
                contentItem = contentArray.find(item => item.id === contentId);
                
                if (!contentItem || contentItem.type !== 'swot') {
                    this.showNotification('SWOT analysis not found', 'error');
                    return;
                }
                
                const suffix = isForSubPlan ? 'SubPlan' : '';
                
                contentItem.data.strengths = document.getElementById(`editSwotStrengths${suffix}`).value.split('\n').filter(s => s.trim());
                contentItem.data.weaknesses = document.getElementById(`editSwotWeaknesses${suffix}`).value.split('\n').filter(w => w.trim());
                contentItem.data.opportunities = document.getElementById(`editSwotOpportunities${suffix}`).value.split('\n').filter(o => o.trim());
                contentItem.data.threats = document.getElementById(`editSwotThreats${suffix}`).value.split('\n').filter(t => t.trim());
                
                this.hideContentForm(formId);
                
                if (isForSubPlan) {
                    this.renderSubPlanModalContent(this.currentSubPlan);
                } else {
                    this.renderModalContent(this.currentPlan);
                }
                
                this.showNotification('SWOT analysis updated! 📊', 'success');
            }

            updateProgressTracker(formId, contentId, isForSubPlan = false) {
                let contentArray, contentItem;
                
                if (isForSubPlan) {
                    contentArray = this.currentSubPlan.content;
                } else {
                    contentArray = this.currentPlan.content;
                }
                
                contentItem = contentArray.find(item => item.id === contentId);
                
                if (!contentItem || contentItem.type !== 'progress') {
                    this.showNotification('Progress tracker not found', 'error');
                    return;
                }
                
                const suffix = isForSubPlan ? 'SubPlan' : '';
                
                const title = document.getElementById(`editProgressTitle${suffix}`).value || 'Progress Tracker';
                const current = parseFloat(document.getElementById(`editProgressCurrent${suffix}`).value) || 0;
                const target = parseFloat(document.getElementById(`editProgressTarget${suffix}`).value) || 100;
                const unit = document.getElementById(`editProgressUnit${suffix}`).value || '';
                const status = document.getElementById(`editProgressStatus${suffix}`).value || 'on-track';
                const startDate = document.getElementById(`editProgressStartDate${suffix}`).value;
                const endDate = document.getElementById(`editProgressEndDate${suffix}`).value;
                const notes = document.getElementById(`editProgressNotes${suffix}`).value || '';
                
                // Parse milestones
                const milestonesText = document.getElementById(`editProgressMilestones${suffix}`).value;
                const milestones = milestonesText.split('\n')
                    .filter(m => m.trim())
                    .map(m => {
                        const parts = m.split(':');
                        return {
                            label: parts[0]?.trim() || `Milestone ${Math.random().toString(36).substr(2, 5)}`,
                            value: parseFloat(parts[1]?.trim()) || 0,
                            completed: false
                        };
                    });
                
                if (target <= 0) {
                    this.showNotification('Target value must be greater than 0', 'warning');
                    return;
                }
                
                contentItem.data.title = title;
                contentItem.data.current = current;
                contentItem.data.target = target;
                contentItem.data.unit = unit;
                contentItem.data.status = status;
                contentItem.data.startDate = startDate;
                contentItem.data.endDate = endDate;
                contentItem.data.milestones = milestones;
                contentItem.data.notes = notes;
                
                this.hideContentForm(formId);
                
                if (isForSubPlan) {
                    this.renderSubPlanModalContent(this.currentSubPlan);
                } else {
                    this.renderModalContent(this.currentPlan);
                }
                
                this.showNotification('Progress tracker updated! 🚀', 'success');
            }

            // FIXED: Checkbox update method
            async updateCheckbox(contentId, taskIndex, completed, isForSubPlan = false) {
                let contentArray;
                if (isForSubPlan) {
                    contentArray = this.currentSubPlan.content;
                } else {
                    contentArray = this.currentPlan.content;
                }
                
                const contentItem = contentArray.find(c => c.id === contentId);
                
                if (contentItem && contentItem.data.tasks && contentItem.data.tasks[taskIndex]) {
                    contentItem.data.tasks[taskIndex].completed = completed;
                    
                    try {
                        const planId = isForSubPlan ? this.currentSubPlan.id : this.currentPlan.id;
                        await fetch(`${this.apiBaseUrl}/api/plans/${planId}/checklist/${contentId}/task/${taskIndex}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ completed })
                        });
                        
                        // Award XP for completing tasks
                        if (completed) {
                            this.userData.xp += 10;
                            this.showNotification('+10 XP for completing task! ⚡', 'info');
                        }
                        
                        // Re-render the content
                        if (isForSubPlan) {
                            this.renderSubPlanModalContent(this.currentSubPlan);
                        } else {
                            this.renderModalContent(this.currentPlan);
                        }
                    } catch (error) {
                        console.error('Error updating checkbox:', error);
                    }
                }
            }

            // File Upload Methods
            async openUploadModal() {
                document.getElementById('uploadModal').style.display = 'flex';
                this.uploadedImages = [];
                this.updateUploadedImagesPreview();
                
                // Hide add content panel when opening upload modal
                document.getElementById('addContentPanel').style.display = 'none';
                this.removeBlurFromAllModals();
            }

            closeUploadModal() {
                document.getElementById('uploadModal').style.display = 'none';
                this.uploadedImages = [];
                document.getElementById('uploadProgress').innerHTML = '';
                document.getElementById('uploadedImages').innerHTML = '';
            }

            handleFileSelect(e) {
                const files = Array.from(e.target.files);
                this.handleFiles(files);
            }

            async handleFiles(files) {
                const validFiles = files.filter(file => {
                    const validImageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/svg+xml'];
                    const validDocTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/plain'];
                    return validImageTypes.includes(file.type) || validDocTypes.includes(file.type) || file.type === '';
                });

                if (validFiles.length === 0) {
                    this.showNotification('Please select valid files (images, PDF, DOC, TXT)', 'warning');
                    return;
                }

                // Upload to Cloudinary via backend
                const formData = new FormData();
                validFiles.forEach(file => {
                    formData.append('files', file);
                });

                try {
                    const response = await fetch(`${this.apiBaseUrl}/api/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    if (result.success) {
                        result.data.forEach(fileData => {
                            this.uploadedImages.push({
                                name: fileData.public_id || 'image',
                                url: fileData.url,
                                preview: fileData.url,
                                type: 'image'
                            });
                        });
                        this.updateUploadedImagesPreview();
                        this.showNotification(`Uploaded ${result.data.length} files successfully!`, 'success');
                    } else {
                        this.showNotification('Upload failed', 'error');
                    }
                } catch (error) {
                    console.error('Error uploading files:', error);
                    this.showNotification('Failed to upload files', 'error');
                }
            }

            getFileIcon(fileType) {
                if (fileType.startsWith('image/')) return 'fa-image';
                if (fileType === 'application/pdf') return 'fa-file-pdf';
                if (fileType.includes('word') || fileType.includes('document')) return 'fa-file-word';
                if (fileType === 'text/plain') return 'fa-file-alt';
                return 'fa-file';
            }

            updateUploadedImagesPreview() {
                const container = document.getElementById('uploadedImages');
                container.innerHTML = '';
                
                this.uploadedImages.forEach((file, index) => {
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'uploaded-image';
                    
                    if (file.preview) {
                        fileDiv.innerHTML = `
                            <img src="${file.preview}" alt="${file.name}">
                            <button class="remove-image" onclick="dashboard.removeUploadedImage(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                    } else {
                        fileDiv.innerHTML = `
                            <div style="width: 100%; height: 150px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--gray-100);">
                                <i class="${file.icon}" style="font-size: 2.052rem; color: var(--gray-500); margin-bottom: 0.5rem;"></i>
                                <div style="font-size: 0.7695rem; color: var(--gray-600); text-align: center; padding: 0 0.5rem;">
                                    ${file.name.length > 20 ? file.name.substring(0, 20) + '...' : file.name}
                                </div>
                            </div>
                            <button class="remove-image" onclick="dashboard.removeUploadedImage(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                    }
                    
                    container.appendChild(fileDiv);
                });
                
                // Update save button state
                const saveBtn = document.getElementById('saveImagesBtn');
                saveBtn.disabled = this.uploadedImages.length === 0;
            }

            removeUploadedImage(index) {
                this.uploadedImages.splice(index, 1);
                this.updateUploadedImagesPreview();
            }

            async saveImagesToPlan() {
                if (this.uploadedImages.length === 0) {
                    this.showNotification('No files to save', 'warning');
                    return;
                }
                
                const images = this.uploadedImages.filter(f => f.type === 'image');
                
                const isSubPlanModalOpen = document.getElementById('subPlanModalOverlay').style.display === 'flex';
                
                let parentPlan;
                if (isSubPlanModalOpen) {
                    parentPlan = this.currentSubPlan;
                } else {
                    parentPlan = this.currentPlan;
                }
                
                if (!parentPlan.content) {
                    parentPlan.content = [];
                }
                
                if (images.length > 0) {
                    const photoContent = {
                        id: Date.now().toString(),
                        type: 'photo',
                        data: {
                            images: images.map(img => ({
                                name: img.name,
                                url: img.url,
                                preview: img.url,
                                uploaded_at: new Date().toISOString()
                            }))
                        },
                        created_at: new Date().toISOString()
                    };
                    
                    try {
                        const response = await fetch(`${this.apiBaseUrl}/api/plans/${parentPlan.id}/content`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(photoContent)
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            parentPlan.content.push(result.data);
                            this.showNotification(`${this.uploadedImages.length} files saved to project! 💾`, 'success');
                            this.closeUploadModal();
                            
                            if (isSubPlanModalOpen) {
                                this.renderSubPlanModalContent(parentPlan);
                            } else {
                                this.renderModalContent(parentPlan);
                            }
                        }
                    } catch (error) {
                        console.error('Error saving images:', error);
                        this.showNotification('Failed to save images', 'error');
                    }
                }
            }

            // Modal Controls
            toggleModalEditMode() {
                this.modalMode = this.modalMode === 'view' ? 'edit' : 'view';
                const editBtn = document.getElementById('modalEditBtn');
                
                if (this.modalMode === 'edit') {
                    editBtn.innerHTML = '<i class="fas fa-lock"></i>';
                    editBtn.title = 'Lock Editing';
                    this.showNotification('Edit Mode Enabled - You can now add/edit content ✏️', 'info');
                } else {
                    editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                    editBtn.title = 'Edit Mode';
                    
                    // Exit reorder mode if active
                    if (this.reorderMode) {
                        this.toggleReorderMode();
                    }
                    
                    // Hide add content panel
                    document.getElementById('addContentPanel').style.display = 'none';
                    this.removeBlurFromAllModals();
                    
                    this.showNotification('Edit Mode Disabled - Content is now view-only 🔒', 'info');
                }
                
                this.renderModalContent(this.currentPlan);
            }

            toggleCurrentModalEditMode() {
                const isSubPlanModal = document.getElementById('subPlanModalOverlay').style.display === 'flex';
                
                if (isSubPlanModal) {
                    this.subPlanModalMode = this.subPlanModalMode === 'view' ? 'edit' : 'view';
                    const editBtn = document.getElementById('subPlanModalEditBtn');
                    
                    if (this.subPlanModalMode === 'edit') {
                        editBtn.innerHTML = '<i class="fas fa-lock"></i>';
                        editBtn.title = 'Lock Editing';
                        this.showNotification('Sub-project Edit Mode Enabled ✏️', 'info');
                    } else {
                        editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                        editBtn.title = 'Edit Mode';
                        document.getElementById('addContentPanel').style.display = 'none';
                        this.showNotification('Sub-project Edit Mode Disabled 🔒', 'info');
                    }
                    
                    this.renderSubPlanModalContent(this.currentSubPlan);
                } else {
                    this.toggleModalEditMode();
                }
            }

            toggleReorderMode() {
                this.reorderMode = !this.reorderMode;
                const reorderBtn = document.getElementById('reorderBtn');
                const modal = document.getElementById('modal');
                
                if (this.reorderMode) {
                    reorderBtn.classList.add('active');
                    reorderBtn.title = 'Exit Reorder Mode';
                    modal.classList.add('reorder-mode');
                    this.showNotification('Drag items to reorder! 👆', 'info');
                } else {
                    reorderBtn.classList.remove('active');
                    reorderBtn.title = 'Reorder Items';
                    modal.classList.remove('reorder-mode');
                }
                
                this.renderModalContent(this.currentPlan);
            }

            toggleAddContentPanel() {
                const addContentPanel = document.getElementById('addContentPanel');
                
                if (addContentPanel.style.display === 'block') {
                    // Hide add content panel
                    addContentPanel.style.display = 'none';
                    
                    // Remove blur from ALL open modals
                    this.removeBlurFromAllModals();
                } else {
                    // Show add content panel
                    addContentPanel.style.display = 'block';
                    
                    // Apply blur to ALL open modals
                    this.applyBlurToAllModals();
                }
            }

            // Apply blur to all modals
            applyBlurToAllModals() {
                const modalElements = [
                    document.getElementById('modal'),
                    document.getElementById('subPlanModal'),
                    document.querySelector('.upload-modal-content')
                ];
                
                modalElements.forEach(modal => {
                    if (modal && modal.style.display !== 'none') {
                        modal.classList.add('modal-blur');
                    }
                });
            }

            // Remove blur from all modals
            removeBlurFromAllModals() {
                const modalElements = [
                    document.getElementById('modal'),
                    document.getElementById('subPlanModal'),
                    document.querySelector('.upload-modal-content')
                ];
                
                modalElements.forEach(modal => {
                    if (modal) {
                        modal.classList.remove('modal-blur');
                    }
                });
            }

            // Drag & Drop for Reordering
            handleDragStart(e, itemDiv) {
                e.dataTransfer.setData('text/plain', itemDiv.dataset.id);
                itemDiv.classList.add('dragging');
                setTimeout(() => {
                    itemDiv.style.display = 'none';
                }, 0);
            }

            handleDragOver(e, itemDiv) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                const draggingElement = document.querySelector('.dragging');
                if (draggingElement && draggingElement !== itemDiv) {
                    const allItems = Array.from(document.querySelectorAll('.content-item'));
                    const draggingIndex = allItems.indexOf(draggingElement);
                    const targetIndex = allItems.indexOf(itemDiv);
                    
                    if (draggingIndex < targetIndex) {
                        itemDiv.parentNode.insertBefore(draggingElement, itemDiv.nextSibling);
                    } else {
                        itemDiv.parentNode.insertBefore(draggingElement, itemDiv);
                    }
                }
            }

            handleDrop(e, itemDiv) {
                e.preventDefault();
                itemDiv.classList.remove('drag-over');
            }

            handleDragEnd(e, itemDiv) {
                itemDiv.classList.remove('dragging');
                itemDiv.style.display = '';
                
                // Update order in content array
                const contentItems = Array.from(document.querySelectorAll('.content-item'));
                const newOrder = contentItems.map(item => {
                    const itemId = parseInt(item.dataset.id);
                    return this.currentPlan.content.find(c => c.id === itemId);
                }).filter(item => item);
                
                this.currentPlan.content = newOrder;
                this.showNotification('Content order updated! 🔄', 'success');
            }

            // Helper Methods
            showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                `;
                
                const notificationArea = document.getElementById('notificationArea');
                notificationArea.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 4000);
            }

            closeModal() {
                document.getElementById('modalOverlay').style.display = 'none';
                this.modalMode = 'view';
                this.reorderMode = false;
                
                // Reset edit button
                const editBtn = document.getElementById('modalEditBtn');
                editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                editBtn.title = 'Edit Mode';
                
                // Reset reorder button
                const reorderBtn = document.getElementById('reorderBtn');
                reorderBtn.classList.remove('active');
                
                // Remove modal classes
                const modal = document.getElementById('modal');
                modal.classList.remove('reorder-mode');
                
                // Hide add content panel
                document.getElementById('addContentPanel').style.display = 'none';
                this.removeBlurFromAllModals();
                
                // Remove any open forms
                const forms = document.querySelectorAll('.content-form');
                forms.forEach(form => form.remove());
            }

            closeSubPlanModal() {
                // Store parent plan before closing
                const parentPlanId = this.currentSubPlan?.parentId;
                
                // Close modal
                document.getElementById('subPlanModalOverlay').style.display = 'none';
                this.subPlanModalMode = 'view';
                
                // Reset edit button
                const subPlanEditBtn = document.getElementById('subPlanModalEditBtn');
                subPlanEditBtn.innerHTML = '<i class="fas fa-edit"></i>';
                subPlanEditBtn.title = 'Edit Mode';
                
                // Hide add content panel
                document.getElementById('addContentPanel').style.display = 'none';
                this.removeBlurFromAllModals();
                
                // Remove any open forms
                const forms = document.querySelectorAll('.content-form');
                forms.forEach(form => form.remove());
                
                // If there's a parent plan, open it
                if (parentPlanId && parentPlanId !== 'null' && parentPlanId !== 'undefined') {
                    const parentPlan = this.allPlansData[parentPlanId];
                    if (parentPlan) {
                        // Check if parent is main plan or another sub-plan
                        if (parentPlan.level === 1) {
                            setTimeout(() => {
                                this.openPlanModal(parentPlan);
                            }, 100);
                        } else {
                            setTimeout(() => {
                                this.openSubPlanModal(parentPlan);
                            }, 100);
                        }
                    }
                }
            }

            // Content Management Methods
            async deleteContentItem(contentId, isForSubPlan = false) {
                if (confirm('Are you sure you want to delete this item?')) {
                    let parentPlan;
                    if (isForSubPlan) {
                        parentPlan = this.currentSubPlan;
                    } else {
                        parentPlan = this.currentPlan;
                    }
                    
                    try {
                        const response = await fetch(`${this.apiBaseUrl}/api/plans/${parentPlan.id}/content/${contentId}`, {
                            method: 'DELETE'
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            parentPlan.content = parentPlan.content.filter(c => c.id !== contentId);
                            
                            if (isForSubPlan) {
                                this.renderSubPlanModalContent(parentPlan);
                            } else {
                                this.renderModalContent(parentPlan);
                            }
                            
                            this.showNotification('Item deleted successfully! 🗑️', 'success');
                        }
                    } catch (error) {
                        console.error('Error deleting content:', error);
                        this.showNotification('Failed to delete item', 'error');
                    }
                }
            }

            editPlan(planId) {
                const plan = this.demoPlans.find(p => p.id === planId);
                if (plan) {
                    // Create edit dialog similar to creation dialog
                    this.showEditPlanDialog(plan);
                }
            }

            showEditPlanDialog(plan) {
                const dialog = document.createElement('div');
                dialog.className = 'modal-overlay';
                dialog.style.display = 'flex';
                dialog.style.zIndex = '2500';
                
                const planNumber = this.generatePlanNumber(plan.id);
                
                dialog.innerHTML = `
                    <div class="modal" style="max-width: 500px;">
                        <div class="modal-header">
                            <h2><i class="fas fa-edit"></i> Edit Plan</h2>
                            <button class="icon-btn close-btn" id="closeEditPlanDialog">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-content">
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Plan Title *</label>
                                <input type="text" id="editPlanTitle" placeholder="Enter plan title" class="form-input" value="${plan.title || ''}" required>
                            </div>
                            
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.89775rem; color: var(--gray-600);">Plan Photo</label>
                                <div id="editPlanPhotoPreview" style="width: 100px; height: 100px; border-radius: var(--radius); overflow: hidden; margin-bottom: 1rem; border: 2px solid var(--gray-300);">
                                    ${plan.photo ? `
                                        <img src="${plan.photo}" alt="${plan.title}" style="width: 100%; height: 100%; object-fit: cover;">
                                    ` : `
                                        <div class="plan-card-photo-placeholder" style="width: 100%; height: 100%;">
                                            <i class="fas fa-camera"></i>
                                        </div>
                                    `}
                                </div>
                                <input type="file" id="editPlanPhotoInput" accept="image/*" style="display: none;">
                                <button class="btn" id="editUploadPlanPhotoBtn" style="width: 100%;">
                                    <i class="fas fa-upload"></i> ${plan.photo ? 'Change Photo' : 'Upload Photo'}
                                </button>
                            </div>
                            
                            <div style="margin-top: 2rem; padding: 1rem; background: var(--gray-100); border-radius: var(--radius);">
                                <div style="font-weight: 500; margin-bottom: 0.5rem;">Preview:</div>
                                <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: white; border-radius: var(--radius); border: 1px solid var(--gray-300);">
                                    <div id="editPlanPreviewPhoto" style="width: 50px; height: 50px; border-radius: var(--radius); overflow: hidden; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; color: white;">
                                        ${plan.photo ? `<img src="${plan.photo}" alt="${plan.title}" style="width: 100%; height: 100%; object-fit: cover;">` : `<i class="fas fa-cube"></i>`}
                                    </div>
                                    <div>
                                        <div style="font-size: 0.89775rem; color: var(--primary); font-weight: 500;">${planNumber}.</div>
                                        <div id="editPlanPreviewTitle" style="font-weight: 600; color: var(--dark);">${plan.title}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-actions" style="margin-top: 2rem;">
                                <button class="btn btn-success" id="savePlanBtn">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                                <button class="btn" id="cancelEditPlanBtn">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(dialog);
                
                // Add event listeners
                document.getElementById('closeEditPlanDialog').addEventListener('click', () => dialog.remove());
                document.getElementById('cancelEditPlanBtn').addEventListener('click', () => dialog.remove());
                
                // Update preview when title changes
                document.getElementById('editPlanTitle').addEventListener('input', (e) => {
                    document.getElementById('editPlanPreviewTitle').textContent = e.target.value || plan.title;
                });
                
                // Photo upload
                document.getElementById('editUploadPlanPhotoBtn').addEventListener('click', () => {
                    document.getElementById('editPlanPhotoInput').click();
                });
                
                document.getElementById('editPlanPhotoInput').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const photoUrl = event.target.result;
                            document.getElementById('editPlanPhotoPreview').innerHTML = `<img src="${photoUrl}" alt="Plan Photo" style="width: 100%; height: 100%; object-fit: cover;">`;
                            document.getElementById('editPlanPreviewPhoto').innerHTML = `<img src="${photoUrl}" alt="Plan Photo" style="width: 100%; height: 100%; object-fit: cover;">`;
                        };
                        reader.readAsDataURL(file);
                    }
                });
                
                // Save changes
                document.getElementById('savePlanBtn').addEventListener('click', async () => {
                    const title = document.getElementById('editPlanTitle').value;
                    const photoPreview = document.querySelector('#editPlanPhotoPreview img');
                    const photo = photoPreview ? photoPreview.src : plan.photo;
                    
                    if (!title.trim()) {
                        this.showNotification('Please enter plan title', 'warning');
                        return;
                    }
                    
                    try {
                        const response = await fetch(`${this.apiBaseUrl}/api/plans/${plan.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ title, photo })
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            plan.title = title.trim();
                            plan.photo = photo;
                            
                            // Update in allPlansData
                            this.allPlansData[plan.id].title = title.trim();
                            this.allPlansData[plan.id].photo = photo;
                            
                            // Update current plan if open
                            if (this.currentPlan && this.currentPlan.id === plan.id) {
                                this.currentPlan.title = title.trim();
                                this.currentPlan.photo = photo;
                                document.getElementById('modalTitle').textContent = title.trim();
                            }
                            
                            this.renderPlans(this.demoPlans);
                            dialog.remove();
                            
                            this.showNotification('Plan updated successfully! ✏️', 'success');
                        }
                    } catch (error) {
                        console.error('Error updating plan:', error);
                        this.showNotification('Failed to update plan', 'error');
                    }
                });
            }

            async deletePlan(planId) {
                if (confirm('Are you sure you want to delete this plan and all its sub-projects? This action cannot be undone.')) {
                    try {
                        const response = await fetch(`${this.apiBaseUrl}/api/plans/${planId}`, {
                            method: 'DELETE'
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            // Remove from demo plans
                            this.demoPlans = this.demoPlans.filter(p => p.id !== planId);
                            
                            // Remove from all plans data and all children recursively
                            this.removePlanAndChildren(planId);
                            
                            // Update UI
                            this.renderPlans(this.demoPlans);
                            
                            if (this.currentPlan && this.currentPlan.id === planId) {
                                this.closeModal();
                            }
                            if (this.currentSubPlan && (this.currentSubPlan.id === planId || this.currentSubPlan.parentId === planId)) {
                                this.closeSubPlanModal();
                            }
                            
                            this.showNotification('Plan and all sub-projects deleted! 🗑️', 'success');
                        }
                    } catch (error) {
                        console.error('Error deleting plan:', error);
                        this.showNotification('Failed to delete plan', 'error');
                    }
                }
            }

            removePlanAndChildren(planId) {
                const plan = this.allPlansData[planId];
                if (!plan) return;
                
                // Remove all children recursively
                if (plan.children) {
                    plan.children.forEach(childId => {
                        this.removePlanAndChildren(childId);
                    });
                }
                
                // Remove from parent's children list
                if (plan.parentId && this.allPlansData[plan.parentId]) {
                    const parentPlan = this.allPlansData[plan.parentId];
                    if (parentPlan.children) {
                        parentPlan.children = parentPlan.children.filter(id => id !== planId);
                    }
                }
                
                // Remove from all plans data
                delete this.allPlansData[planId];
            }
        }

        // Initialize the dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.dashboard = new LifeDashboard();
        });
    </script>
</body>
</html>